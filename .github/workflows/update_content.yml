name: Update Content List

on:
  push:
    paths:
      - 'Games/**'
      - 'Interactive_Activities/**'
  workflow_dispatch: # Manuel tetikleme iÃ§in de buton ekledim

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
    - uses: actions/checkout@v3

    - name: Generate JSON with Smart Merge Logic
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const path = require('path');

          const gamesDir = 'Games';
          const activitiesDir = 'Interactive_Activities';
          const outputFile = 'games_data.json';
          
          let results = [];
          let existingData = {};

          // --- 1. HAFIZA: MEVCUT VERÄ°YÄ° OKU VE SAKLA ---
          if (fs.existsSync(outputFile)) {
            try {
              const rawData = fs.readFileSync(outputFile, 'utf8');
              const json = JSON.parse(rawData);
              // Verileri 'path' (dosya yolu) anahtarÄ± ile sakla
              json.forEach(item => {
                existingData[item.path] = item;
              });
              console.log("âœ… Mevcut ayarlar hafÄ±zaya alÄ±ndÄ±.");
            } catch (e) {
              console.log("âš ï¸ Eski dosya okunamadÄ±, sÄ±fÄ±rdan oluÅŸturuluyor.");
            }
          }

          // --- 2. GAMES KLASÃ–RÃœNÃœ TARA ---
          if (fs.existsSync(gamesDir)) {
            fs.readdirSync(gamesDir).forEach(grade => {
              const gradePath = path.join(gamesDir, grade);
              if (fs.statSync(gradePath).isDirectory()) {
                fs.readdirSync(gradePath).forEach(gameName => {
                  const gamePath = path.join(gradePath, gameName);
                  if (fs.statSync(gamePath).isDirectory()) {
                    if (fs.existsSync(path.join(gamePath, 'index.html'))) {
                      
                      // Dosya yolunu oluÅŸtur
                      const fullPath = `${gamesDir}/${grade}/${gameName}/index.html`;
                      
                      // Eski veriyi hatÄ±rla (Varsa)
                      const oldItem = existingData[fullPath];

                      results.push({
                        // EÄŸer admin panelinden baÅŸlÄ±k deÄŸiÅŸtirildiyse onu koru, yoksa klasÃ¶r adÄ±nÄ± yaz
                        title: (oldItem && oldItem.title) ? oldItem.title : gameName,
                        name: gameName, // Orijinal klasÃ¶r adÄ± teknik referans iÃ§in kalsÄ±n
                        path: fullPath,
                        type: 'dir',
                        grade: grade,
                        source: 'Games',
                        // GÃ¶rÃ¼nÃ¼rlÃ¼k ayarÄ±nÄ± koru (VarsayÄ±lan: true)
                        isVisible: (oldItem && oldItem.isVisible !== undefined) ? oldItem.isVisible : true,
                        // AÃ§Ä±klamayÄ± koru
                        description: (oldItem && oldItem.description) ? oldItem.description : ""
                      });
                    }
                  }
                });
              }
            });
          }

          // --- 3. INTERACTIVE ACTIVITIES KLASÃ–RÃœNÃœ TARA ---
          if (fs.existsSync(activitiesDir)) {
            fs.readdirSync(activitiesDir).forEach(grade => {
              const gradePath = path.join(activitiesDir, grade);
              if (fs.statSync(gradePath).isDirectory()) {
                fs.readdirSync(gradePath).forEach(file => {
                  if (file.endsWith('.html')) {
                    
                    const fullPath = `${activitiesDir}/${grade}/${file}`;
                    const oldItem = existingData[fullPath];
                    // Dosya adÄ±ndan .html uzantÄ±sÄ±nÄ± kaldÄ±rÄ±p geÃ§ici baÅŸlÄ±k yap
                    const cleanName = file.replace('.html', '');

                    results.push({
                      title: (oldItem && oldItem.title) ? oldItem.title : cleanName,
                      name: file,
                      path: fullPath,
                      type: 'file',
                      grade: grade,
                      source: 'Interactive_Activities',
                      isVisible: (oldItem && oldItem.isVisible !== undefined) ? oldItem.isVisible : true,
                      description: (oldItem && oldItem.description) ? oldItem.description : ""
                    });
                  }
                });
              }
            });
          }

          // --- 4. DOSYAYI YAZ ---
          fs.writeFileSync(outputFile, JSON.stringify(results, null, 2));
          console.log(`ðŸŽ‰ Toplam ${results.length} iÃ§erik gÃ¼ncellendi.`);

    - name: Commit and Push
      run: |
        git config --global user.name 'GitHub Action'
        git config --global user.email 'action@github.com'
        git add games_data.json
        # Sadece deÄŸiÅŸiklik varsa commit at, yoksa hata verme
        git diff --quiet && git diff --staged --quiet || (git commit -m "Update games list (Smart Merge) ðŸ¤–" && git push)
