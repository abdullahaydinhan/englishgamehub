name: Update Content List

on:
  push:
    paths:
      - 'Games/**'
      - 'Interactive_Activities/**'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
    - uses: actions/checkout@v3

    - name: Generate JSON with FULL CMS Logic
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const path = require('path');

          const gamesDir = 'Games';
          const activitiesDir = 'Interactive_Activities';
          const outputFile = 'games_data.json';
          
          let results = [];
          let existingData = {};

          // --- 1. HAFIZA: ESKÄ° VERÄ°LERÄ° OKU ---
          if (fs.existsSync(outputFile)) {
            try {
              const rawData = fs.readFileSync(outputFile, 'utf8');
              const json = JSON.parse(rawData);
              json.forEach(item => { existingData[item.path] = item; });
              console.log("âœ… Mevcut veri hafÄ±zaya alÄ±ndÄ±.");
            } catch (e) { console.log("âš ï¸ Eski veri okunamadÄ±."); }
          }

          // --- FONKSÄ°YON: VERÄ° BÄ°RLEÅžTÄ°RME ---
          function createEntry(realPath, name, defaultGrade, defaultSource) {
             const old = existingData[realPath];
             return {
                // DeÄŸiÅŸmeyen teknik veriler
                path: realPath,
                name: name,
                
                // --- YÃ–NETÄ°LEBÄ°LÄ°R ALANLAR (Admin panelinden gelenler korunur) ---
                title: (old && old.title) ? old.title : name.replace(/_/g, ' '),
                description: (old && old.description) ? old.description : "",
                
                // EÄŸer adminden sÄ±nÄ±f deÄŸiÅŸtirildiyse onu kullan, yoksa klasÃ¶r adÄ±nÄ± al
                grade: (old && old.grade) ? old.grade : defaultGrade,
                
                // EÄŸer adminden tÃ¼r deÄŸiÅŸtirildiyse onu kullan
                source: (old && old.source) ? old.source : defaultSource,
                
                // Yeni Ã¶zellikler
                unit: (old && old.unit) ? old.unit : "", // Ãœnite Bilgisi
                badgeColor: (old && old.badgeColor) ? old.badgeColor : "bg-primary", // Renk
                isFeatured: (old && old.isFeatured) ? old.isFeatured : false, // Favori mi?
                
                // GÃ¶rÃ¼nÃ¼rlÃ¼k
                isVisible: (old && old.isVisible !== undefined) ? old.isVisible : true
             };
          }

          // --- 2. TARAMA ---
          
          // Games
          if (fs.existsSync(gamesDir)) {
            fs.readdirSync(gamesDir).forEach(grade => {
              const gradePath = path.join(gamesDir, grade);
              if (fs.statSync(gradePath).isDirectory()) {
                fs.readdirSync(gradePath).forEach(gameName => {
                  const gamePath = path.join(gradePath, gameName);
                  if (fs.statSync(gamePath).isDirectory() && fs.existsSync(path.join(gamePath, 'index.html'))) {
                    const fullPath = `${gamesDir}/${grade}/${gameName}/index.html`;
                    results.push(createEntry(fullPath, gameName, grade, 'Games'));
                  }
                });
              }
            });
          }

          // Activities
          if (fs.existsSync(activitiesDir)) {
            fs.readdirSync(activitiesDir).forEach(grade => {
              const gradePath = path.join(activitiesDir, grade);
              if (fs.statSync(gradePath).isDirectory()) {
                fs.readdirSync(gradePath).forEach(file => {
                  if (file.endsWith('.html')) {
                    const fullPath = `${activitiesDir}/${grade}/${file}`;
                    const cleanName = file.replace('.html', '');
                    results.push(createEntry(fullPath, cleanName, grade, 'Interactive_Activities'));
                  }
                });
              }
            });
          }

          // --- 3. KAYDET ---
          fs.writeFileSync(outputFile, JSON.stringify(results, null, 2));

    - name: Commit and Push
      run: |
        git config --global user.name 'GitHub Action'
        git config --global user.email 'action@github.com'
        git add games_data.json
        git diff --quiet && git diff --staged --quiet || (git commit -m "Update DB with CMS fields ðŸŒŸ" && git push)
