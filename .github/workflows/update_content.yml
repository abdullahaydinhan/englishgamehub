name: Update Content List

on:
  push:
    paths:
      - 'Games/**'
      - 'Interactive_Activities/**'
      - 'Vocabulary/**'
      - 'Videos/**'
      - 'Grammar/**'
      - 'Slides/**'
      - 'Documents/**'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0 # Tarih bilgisini doÄŸru almak iÃ§in geÃ§miÅŸi Ã§ek

    - name: Generate JSON with DATE Support
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const path = require('path');

          // KLASÃ–R TANIMLARI
          const dirs = {
            'Games': 'Games',
            'Interactive_Activities': 'Interactive_Activities',
            'Vocabulary': 'Vocabulary',
            'Videos': 'Videos',
            'Grammar': 'Grammar',
            'Slides': 'Slides',
            'Documents': 'Documents'
          };
          
          const outputFile = 'games_data.json';
          let results = [];
          let existingData = {};

          // HAFIZA OKUMA
          if (fs.existsSync(outputFile)) {
            try {
              const rawData = fs.readFileSync(outputFile, 'utf8');
              const json = JSON.parse(rawData);
              json.forEach(item => { existingData[item.path] = item; });
            } catch (e) { console.log("Eski veri okunamadÄ±."); }
          }

          // TARÄ°H FORMATLAYICI (GG.AA.YYYY)
          function formatDate(date) {
              const d = new Date(date);
              const day = String(d.getDate()).padStart(2, '0');
              const month = String(d.getMonth() + 1).padStart(2, '0');
              const year = d.getFullYear();
              return `${day}.${month}.${year}`;
          }

          function createEntry(realPath, name, defaultGrade, defaultSource, mtime) {
             const old = existingData[realPath];
             
             const cleanName = name.replace(/\.(html|pdf|docx|doc|xlsx|xls|ppt|pptx)$/i, '').replace(/_/g, ' ');
             const finalTitle = (old && old.title) ? old.title : cleanName;
             const finalSource = (old && old.source) ? old.source : defaultSource;

             let defColor = 'bg-primary';
             if (finalSource === 'Interactive_Activities') defColor = 'bg-info';
             if (finalSource === 'Vocabulary') defColor = 'bg-success';
             if (finalSource === 'Videos') defColor = 'bg-danger';
             if (finalSource === 'Grammar') defColor = 'bg-warning text-dark';
             if (finalSource === 'Slides') defColor = 'bg-dark';
             if (finalSource === 'Documents') defColor = 'bg-info';

             // Tarih: EÄŸer eski veride varsa koru (deÄŸiÅŸiklik yoksa), yoksa dosya tarihini al
             // Not: GitHub Actions'da dosya tarihi bazen "push" anÄ± olur.
             const fileDate = formatDate(mtime);

             return {
                path: realPath,
                name: name,
                title: finalTitle,
                description: (old && old.description) ? old.description : "Click to view.",
                grade: (old && old.grade) ? old.grade : defaultGrade,
                source: finalSource,
                unit: (old && old.unit) ? old.unit : "",
                badgeColor: (old && old.badgeColor) ? old.badgeColor : defColor,
                isFeatured: (old && old.isFeatured) ? old.isFeatured : false,
                isVisible: (old && old.isVisible !== undefined) ? old.isVisible : true,
                date: fileDate // YENÄ° ALAN
             };
          }

          // TARAMA DÃ–NGÃœSÃœ
          Object.keys(dirs).forEach(sourceType => {
            const dirPath = dirs[sourceType];
            
            if (fs.existsSync(dirPath)) {
              fs.readdirSync(dirPath).forEach(grade => {
                const gradePath = path.join(dirPath, grade);
                if (fs.statSync(gradePath).isDirectory()) {
                  fs.readdirSync(gradePath).forEach(file => {
                    const fullPath = path.join(gradePath, file);
                    const stats = fs.statSync(fullPath); // Dosya bilgilerini al
                    const webPath = `${dirPath}/${grade}/${file}`;

                    if (fs.statSync(fullPath).isDirectory()) {
                        if (fs.existsSync(path.join(fullPath, 'index.html'))) {
                            // KlasÃ¶rÃ¼n tarihini al
                            results.push(createEntry(`${webPath}/index.html`, file, grade, sourceType, stats.mtime));
                        }
                    } 
                    else {
                        let regex = /\.(html|pdf|docx|doc|xlsx|xls)$/i;
                        if (sourceType === 'Slides') regex = /\.(html|pdf|docx|doc|xlsx|xls|ppt|pptx)$/i;

                        if (file.match(regex)) {
                            results.push(createEntry(webPath, file, grade, sourceType, stats.mtime));
                        }
                    }
                  });
                }
              });
            }
          });

          fs.writeFileSync(outputFile, JSON.stringify(results, null, 2));

    - name: Commit and Push
      run: |
        git config --global user.name 'GitHub Action'
        git config --global user.email 'action@github.com'
        git add games_data.json
        git diff --quiet && git diff --staged --quiet || (git commit -m "Updated: Content with Dates ðŸ“…" && git push)
