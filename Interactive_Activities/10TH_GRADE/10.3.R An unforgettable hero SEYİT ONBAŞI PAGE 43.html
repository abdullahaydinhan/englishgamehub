<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>10.3.R ‚Äì An Unforgettable Hero: Seyit Onba≈üƒ± (A2‚ÄìB1) ‚Äì v4 (Sally-Style Highlight)</title>
<style>
  :root{
    --bg-color:#0f1b2d; --primary-color:#15223a; --secondary-color:#103257;
    --accent-color:#ff4d6d; --accent-hover-color:#4d3e7a; --text-color:#f5f5f5;
    --font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
  }
  *{margin:0;padding:0;box-sizing:border-box}
  body{
    font-family:var(--font-family); background:var(--bg-color); color:var(--text-color);
    line-height:1.6; height:100vh; display:flex; flex-direction:column; overflow:hidden;
  }
  header{
    background:var(--primary-color); padding:15px 20px; display:flex; justify-content:space-between; align-items:center;
    box-shadow:0 2px 10px rgba(0,0,0,.3); min-height:70px;
  }
  .title{font-size:24px; font-weight:800}
  .controls{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  select{
    padding:8px 12px; border-radius:8px; border:1px solid var(--accent-color);
    background:var(--secondary-color); color:var(--text-color); font-size:14px; cursor:pointer;
  }
  .score-display{font-size:18px; font-weight:700; color:#f39c12; margin-right:8px}
  button{
    background:var(--secondary-color); color:#fff; border:none; padding:10px 16px; border-radius:10px; cursor:pointer;
    font-size:16px; font-weight:600; transition:background-color .25s,transform .05s ease;
  }
  button:hover{background:var(--accent-hover-color)}
  main{flex:1; display:flex; flex-direction:column; overflow:hidden; padding:20px; min-height:0}
  .content-wrapper{display:flex; flex-direction:column; flex:1; min-height:0; gap:20px}
  .reading{
    background:var(--secondary-color); padding:24px; border-radius:14px; overflow-y:auto;
    box-shadow:0 4px 10px rgba(0,0,0,.25); flex:1; min-height:0; display:flex; flex-direction:column
  }
  .reading h2{margin-bottom:12px}
  .reading p{margin-bottom:20px; font-size:20px; text-align:justify}
  .highlight{
    background:var(--accent-color);
    color:#fff;
    padding:2px 6px;
    border-radius:6px;
    font-weight:800;
    outline:3px solid rgba(255,255,255,.25);
    box-shadow:0 0 0 3px rgba(255,77,109,.35);
  }
  .qbox{background:var(--primary-color); padding:24px; border-radius:14px; box-shadow:0 4px 10px rgba(0,0,0,.25)}
  .question{font-size:22px; margin-bottom:18px; font-weight:700}
  .options{display:grid; grid-template-columns:1fr 1fr; gap:14px; margin-bottom:14px}
  .option{background:var(--secondary-color); padding:14px; border-radius:12px; cursor:pointer; transition:all .2s; font-size:18px; border:2px solid transparent; text-align:center}
  .option:hover{background:var(--accent-hover-color); transform:translateY(-1px)}
  .option.selected{background:var(--accent-hover-color); border-color:var(--accent-color)}
  .answer{display:none; background:#27ae60; padding:12px; border-radius:10px; margin-top:12px; font-size:18px; font-weight:700}
  .hint{display:none; background:#34495e; padding:12px; border-radius:10px; margin-top:12px; font-size:18px; font-weight:600; border-left:4px solid var(--accent-color)}
  .button-group{display:flex; gap:10px; margin-top:10px; flex-wrap:wrap}
  input[type="text"],textarea{
    width:100%; padding:14px; background:var(--secondary-color); color:var(--text-color);
    border:2px solid var(--accent-hover-color); border-radius:10px; font-size:18px; margin-bottom:10px;
  }
  input[type="text"]:focus,textarea:focus{outline:none; border-color:var(--accent-color)}
  .vocab-grid{display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:16px; padding:10px; overflow-y:auto; flex:1}
  .vocab-card{
    background:var(--secondary-color); padding:18px; border-radius:12px; cursor:pointer; text-align:center;
    transition:all .2s; min-height:110px; display:flex; align-items:center; justify-content:center; font-size:18px; font-weight:700; border:2px solid transparent
  }
  .vocab-card:hover{transform:translateY(-3px); background:var(--accent-hover-color); border-color:var(--accent-color)}
  .vocab-card.flipped{background:var(--accent-color); border-color:#fff}
  .vocab-game-container{display:flex; flex:1; gap:24px; padding:10px; justify-content:center; align-items:flex-start}
  .vocab-game-column{display:flex; flex-direction:column; gap:10px; width:45%}
  .vocab-game-card{
    background:var(--secondary-color); padding:14px; border-radius:12px; cursor:pointer; text-align:center;
    transition:all .2s; font-size:18px; font-weight:700; border:3px solid transparent; user-select:none
  }
  .vocab-game-card:hover{transform:translateY(-2px); background:var(--accent-hover-color)}
  .vocab-game-card.selected{border-color:#f39c12; background:var(--accent-hover-color); transform:scale(1.03)}
  .vocab-game-card.matched{background:#27ae60; border-color:#2ecc71; cursor:default; transform:scale(1)}
  .vocab-game-card.incorrect{animation:shake .4s; background:#c0392b; border-color:#e74c3c}
  @keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-8px)}75%{transform:translateX(8px)}}
  nav{display:flex; flex-direction:column; justify-content:center; align-items:center; padding:14px 20px; background:var(--primary-color); box-shadow:0 -2px 10px rgba(0,0,0,.3); min-height:80px}
  .progress-container{width:100%; height:10px; background:var(--secondary-color); border-radius:6px; margin-bottom:10px; overflow:hidden}
  .progress-bar{height:100%; width:0%; background:var(--accent-color); transition:width .25s ease-in-out}
  .nav-buttons{display:flex; justify-content:space-between; width:100%}
  #pageIndicator{font-size:18px; font-weight:700}
  footer{background:var(--secondary-color); padding:12px; text-align:center; font-size:16px; font-weight:600}
  .completion{display:none; flex-direction:column; align-items:center; justify-content:center; height:100%; text-align:center; padding:30px}
  .completion h1{font-size:48px; margin-bottom:20px; color:var(--accent-color)}
  .completion p{font-size:24px; margin-bottom:24px}
  .final-score{font-size:32px; color:#f39c12; margin-bottom:16px}
  body.fullscreen-mode .reading p{font-size:24px}
  body.fullscreen-mode .question{font-size:28px}
  body.fullscreen-mode .option{font-size:20px; padding:16px}
  body.fullscreen-mode input[type="text"],body.fullscreen-mode textarea{font-size:26px; padding:18px}
  body.fullscreen-mode .answer,body.fullscreen-mode .hint{font-size:24px; padding:16px}
  body.theme-light{--bg-color:#f5f5f5;--primary-color:#e0e0e0;--secondary-color:#ffffff;--accent-color:#3498db;--accent-hover-color:#2980b9;--text-color:#333}
  body.theme-nature{--bg-color:#2c3e27;--primary-color:#3e4f37;--secondary-color:#4a6b49;--accent-color:#8bc34a;--accent-hover-color:#7cb342;--text-color:#e8f5e9}
  body.theme-tech{--bg-color:#263238;--primary-color:#37474f;--secondary-color:#455a64;--accent-color:#00bcd4;--accent-hover-color:#00acc1;--text-color:#eceff1}
</style>
</head>
<body>
<header>
  <div class="title">An Unforgettable Hero: Seyit Onba≈üƒ± (A2‚ÄìB1)</div>
  <div class="controls">
    <div class="score-display">Score: <span id="score">0</span></div>
    <select id="themeSelector" title="Theme">
      <option value="dark-blue" selected>Dark Blue</option>
      <option value="light">Light</option>
      <option value="nature">Nature</option>
      <option value="tech">Tech</option>
    </select>
    <select id="voiceSelector" title="Voice Type">
      <option value="female" selected>US Female</option>
      <option value="male">US Male</option>
    </select>
    <button id="readBtn">üîä Read</button>
    <button id="pauseBtn" style="display:none;">‚è∏Ô∏è Pause</button>
    <button id="resumeBtn" style="display:none;">‚ñ∂Ô∏è Resume</button>
    <button id="stopBtn" style="display:none;">‚èπÔ∏è Stop</button>
    <button id="fullscreenBtn">‚õ∂ Fullscreen</button>
  </div>
</header>

<main>
  <div class="content-wrapper">
    <div class="reading" id="reading">
      <div class="reading-content" id="readingContent"></div>
    </div>

    <div class="qbox" id="qbox"></div>

    <div class="vocab-grid" id="vocabGrid" style="display:none;"></div>
    <div class="vocab-game-container" id="vocabGameContainer" style="display:none;"></div>

    <div class="completion" id="completion">
      <h1>üéâ You've completed all questions!</h1>
      <div class="final-score">Your Final Score: <span id="finalScore">0</span></div>
      <p>Great job!</p>
      <button id="restartBtn">üîÑ Restart</button>
    </div>
  </div>
</main>

<nav>
  <div class="progress-container"><div class="progress-bar" id="progressBar"></div></div>
  <div class="nav-buttons">
    <button id="prevBtn">‚¨ÖÔ∏è Previous</button>
    <span id="pageIndicator">Page 1</span>
    <button id="nextBtn">Next ‚û°Ô∏è</button>
  </div>
</nav>

<footer>Bu √ßalƒ±≈üma ƒ∞ngilizce √ñƒüretmeni Abdullah AYDINHAN tarafƒ±ndan yapƒ±lmƒ±≈ütƒ±r.</footer>

<script>
/* =========================
   CONTENT (Seyit Onba≈üƒ±)
   ========================= */
const TOPIC = "An Unforgettable Hero: Seyit Onba≈üƒ±";
const LEVEL = "A2‚ÄìB1";

/* Reading passage (your text) */
const PASSAGE = `
<h2 style="margin-bottom:12px">An Unforgettable Hero: Seyit Onba≈üƒ±</h2>
<p><strong>A</strong> When you visit <em>Gallipoli</em>, you can see the huge statue of <em>Seyit Onba≈üƒ±</em>. The statue shows him with a big <em>shell</em> in his arms. Seyit Onba≈üƒ± was an Ottoman <em>soldier</em> during the war of <em>√áanakkale</em>. He became a soldier in <em>1909</em>. After 6 years, he was still serving in <em>√áanakkale Rumeli Mecidiye Batarya</em> in <em>1915</em>. Soldiers were fighting on hills and valleys under a <em>rain of fire</em>. They fired shells at the ship <em>Queen Elizabeth</em> and hit her. After that, the enemy fired back to <em>Mecidiye Batarya</em>, killed almost all of the Turkish soldiers and destroyed most of the <em>guns</em>. There was <em>dust</em>, <em>blood</em> and <em>cries</em> everywhere.</p>
<p><strong>B</strong> While the <em>batarya commander</em> and a soldier were walking among the dead soldiers, they saw a soldier under <em>stones</em> and <em>soil</em>. He was <em>Seyit Onba≈üƒ±</em>. He was a tall and strong man. They helped him to stand up. When Seyit Onba≈üƒ± was on his feet, he saw that there was only one <em>cannon</em> in good condition, but it didn‚Äôt work well. Seyit moved. First, he lifted the <em>275 kg shell</em> with the help of his friend, then, put it on his shoulder and finally climbed up to the <em>gun</em> and placed the shell. His love for his country helped him and he fired the cannon. The shell hit the warship <em>Ocean</em> and <em>sank</em> it. The British <em>Admiral</em> told his warships to leave.</p>
<p><strong>C</strong> In the evening of <em>March 18</em>, while the sun was going down and the last enemy warships were sailing away, Turkish commanders were very happy. <em>Cevat Pa≈üa</em>, commander of the <em>√áanakkale Fortified Zone</em>, said: ‚ÄúThey left our coast. They could not break through. They will not break through.‚Äù</p>
`;

/* Vocabulary list (~40, tap-to-flip) */
const VOCAB_LIST = [
  ["hero","kahraman"],
  ["statue","heykel"],
  ["shell","mermi (top)"],
  ["cannon","top"],
  ["soldier","asker"],
  ["commander","komutan"],
  ["warship","sava≈ü gemisi"],
  ["Admiral","amiral"],
  ["gun","silah/top"],
  ["battery (batarya)","batarya/top bataryasƒ±"],
  ["fortified zone","m√ºstahkem mevkii"],
  ["rain of fire","ate≈ü yaƒümuru"],
  ["dust and blood","toz ve kan"],
  ["cries","√ßƒ±ƒülƒ±klar"],
  ["stones and soil","ta≈ü ve toprak"],
  ["valley","vadi"],
  ["hill","tepe"],
  ["hit (v.)","vurmak"],
  ["sink (v.)","batƒ±rmak"],
  ["lift (v.)","kaldƒ±rmak"],
  ["place (v.)","yerle≈ütirmek"],
  ["serve (v.)","hizmet etmek"],
  ["strong","g√º√ßl√º"],
  ["tall","uzun boylu"],
  ["war of √áanakkale","√áanakkale sava≈üƒ±"],
  ["Gallipoli","Gelibolu"],
  ["Queen Elizabeth (ship)","Queen Elizabeth gemisi"],
  ["Ocean (warship)","Ocean sava≈ü gemisi"],
  ["Mecidiye Battery","Mecidiye Bataryasƒ±"],
  ["coast","kƒ±yƒ±"],
  ["break through","yarƒ±p ge√ßmek"],
  ["leave (v.)","ayrƒ±lmak"],
  ["destroy (v.)","yƒ±kmak/imha etmek"],
  ["gun in good condition","iyi durumdaki top"],
  ["275 kg","275 kilogram"],
  ["British","Britanyalƒ±"],
  ["Ottoman","Osmanlƒ±"],
  ["fearless/bravery","korkusuzluk/cesaret"],
  ["battlefield","sava≈ü meydanƒ±"],
  ["duty","g√∂rev"],
  ["nation/country","ulus/vatan"],
  ["victory","zafer"]
];

/* True/False (10) */
const TF_QUESTIONS = [
  { prompt:"The statue in Gallipoli shows Seyit Onba≈üƒ± carrying a big cannon.",
    answer:"False",
    highlights:["The statue shows him with a big shell in his arms"],
    hint:"Statue detail (Paragraph A)."},
  { prompt:"Seyit Onba≈üƒ± was serving at Rumeli Mecidiye Battery in 1915.",
    answer:"True",
    highlights:["serving in √áanakkale Rumeli Mecidiye Batarya in 1915"],
    hint:"Time & place (Paragraph A)."},
  { prompt:"Soldiers fired at Queen Elizabeth and hit it.",
    answer:"True",
    highlights:["fired shells at the ship Queen Elizabeth and hit her"],
    hint:"Action on Queen Elizabeth (A)."},
  { prompt:"The enemy attack left most Turkish guns undamaged.",
    answer:"False",
    highlights:["destroyed most of the guns"],
    hint:"Damage report (A)."},
  { prompt:"Seyit Onba≈üƒ± was found under stones and soil.",
    answer:"True",
    highlights:["saw a soldier under stones and soil. He was Seyit Onba≈üƒ±"],
    hint:"Where he was found (B)."},
  { prompt:"There were many working cannons when Seyit stood up.",
    answer:"False",
    highlights:["only one cannon in good condition, but it didn‚Äôt work well"],
    hint:"Cannon condition (B)."},
  { prompt:"Seyit lifted a 275 kg shell and placed it on the gun.",
    answer:"True",
    highlights:["lifted the 275 kg shell ... placed the shell"],
    hint:"Sequence of actions (B)."},
  { prompt:"The shell hit Ocean and sank it.",
    answer:"True",
    highlights:["The shell hit the warship Ocean and sank it"],
    hint:"Result of the shot (B)."},
  { prompt:"After Ocean sank, the British Admiral ordered all warships to continue fighting.",
    answer:"False",
    highlights:["The British Admiral told his warships to leave"],
    hint:"Order by the Admiral (B)."},
  { prompt:"On March 18 evening, commanders were worried and unhappy.",
    answer:"False",
    highlights:["Turkish commanders were very happy"],
    hint:"Mood of commanders (C)."}
];

/* Multiple Choice (10) */
const MCQ_QUESTIONS = [
  { prompt:"What does the statue in Gallipoli show?",
    options:["Seyit with a sword","Seyit with a big shell","Seyit riding a horse","Seyit holding a flag"],
    answer:1, highlights:["statue shows him with a big shell"], hint:"Paragraph A."},
  { prompt:"In which year was Seyit serving at Rumeli Mecidiye Battery?",
    options:["1909","1912","1915","1918"],
    answer:2, highlights:["serving ... in 1915"], hint:"Paragraph A."},
  { prompt:"Which ship did the soldiers hit before the enemy fired back?",
    options:["Ocean","Queen Elizabeth","HMS Victory","Yavuz"],
    answer:1, highlights:["fired shells at the ship Queen Elizabeth and hit her"], hint:"Paragraph A."},
  { prompt:"What happened to most of the guns after the enemy fired back?",
    options:["They were repaired","They were destroyed","They were moved","They were hidden"],
    answer:1, highlights:["destroyed most of the guns"], hint:"Paragraph A."},
  { prompt:"Where was Seyit found?",
    options:["In a trench","Under stones and soil","On a ship","At the fort gate"],
    answer:1, highlights:["under stones and soil"], hint:"Paragraph B."},
  { prompt:"How heavy was the shell he lifted?",
    options:["125 kg","200 kg","275 kg","350 kg"],
    answer:2, highlights:["275 kg shell"], hint:"Paragraph B."},
  { prompt:"Which warship sank after Seyit fired the cannon?",
    options:["Queen Elizabeth","Ocean","Dreadnought","Midilli"],
    answer:1, highlights:["The shell hit the warship Ocean and sank it"], hint:"Paragraph B."},
  { prompt:"What did the British Admiral order after Ocean sank?",
    options:["Attack again","Stay near the coast","Leave","Send more ships"],
    answer:2, highlights:["told his warships to leave"], hint:"Paragraph B."},
  { prompt:"What is the date mentioned when commanders were happy?",
    options:["April 25","March 18","May 19","August 30"],
    answer:1, highlights:["In the evening of March 18"], hint:"Paragraph C."},
  { prompt:"Who is quoted saying ‚ÄúThey will not break through‚Äù?",
    options:["Seyit Onba≈üƒ±","The British Admiral","Cevat Pa≈üa","Mustafa Kemal"],
    answer:2, highlights:["Cevat Pa≈üa ... said: ‚Äú... They will not break through.‚Äù"], hint:"Paragraph C."}
];

/* Fill-in-the-Blank (10) */
const FILL_QUESTIONS = [
  { prompt:"The statue shows Seyit carrying a big ______.", answer:"shell",
    highlights:["a big shell in his arms"], hint:"Object in statue."},
  { prompt:"Seyit was serving at Rumeli ______ Battery in 1915.", answer:"Mecidiye",
    highlights:["√áanakkale Rumeli Mecidiye Batarya in 1915"], hint:"Proper noun."},
  { prompt:"The soldiers fired at the ship ______ and hit her.", answer:"Queen Elizabeth",
    highlights:["fired shells at the ship Queen Elizabeth and hit her"], hint:"Ship name."},
  { prompt:"The enemy destroyed most of the ______.", answer:"guns",
    highlights:["destroyed most of the guns"], hint:"Weapons."},
  { prompt:"Seyit was found under stones and ______.", answer:"soil",
    highlights:["under stones and soil"], hint:"Ground material."},
  { prompt:"There was only one ______ in good condition.", answer:"cannon",
    highlights:["only one cannon in good condition"], hint:"Artillery."},
  { prompt:"Seyit lifted a ______ kg shell before placing it.", answer:"275",
    highlights:["lifted the 275 kg shell"], hint:"Number."},
  { prompt:"The shell hit the warship ______ and sank it.", answer:"Ocean",
    highlights:["The shell hit the warship Ocean and sank it"], hint:"Ship name."},
  { prompt:"The British ______ told his warships to leave.", answer:"Admiral",
    highlights:["The British Admiral told his warships to leave"], hint:"Rank."},
  { prompt:"Cevat Pa≈üa said they could not ______ through.", answer:"break",
    highlights:["could not break through"], hint:"Verb."}
];

/* Open-Ended (10) */
const OPEN_QUESTIONS = [
  { prompt:"What details on the statue show Seyit‚Äôs strength and role?",
    model:"It shows him carrying a big shell in his arms, highlighting his role with the cannon.",
    highlights:["statue shows him with a big shell","cannon"], hint:"Paragraph A."},
  { prompt:"Summarise what happened to the Turkish battery after hitting Queen Elizabeth.",
    model:"The enemy fired back at Mecidiye Battery, killing most soldiers and destroying most guns.",
    highlights:["the enemy fired back to Mecidiye Batarya","killed almost all of the Turkish soldiers and destroyed most of the guns"], hint:"Paragraph A."},
  { prompt:"Describe how Seyit was found and what he did next.",
    model:"He was found under stones and soil, stood up, lifted a 275 kg shell, climbed up, and placed it on the gun.",
    highlights:["saw a soldier under stones and soil","lifted the 275 kg shell","climbed up to the gun"], hint:"Paragraph B."},
  { prompt:"What was the result of Seyit‚Äôs shot?",
    model:"The shell hit the warship Ocean and sank it; the British Admiral ordered the warships to leave.",
    highlights:["The shell hit the warship Ocean and sank it","The British Admiral told his warships to leave"], hint:"Paragraph B."},
  { prompt:"How does the text describe the battlefield before Seyit was found?",
    model:"There was dust, blood, and cries everywhere after heavy enemy fire.",
    highlights:["There was dust, blood and cries everywhere"], hint:"Paragraph A."},
  { prompt:"What emotions did Turkish commanders feel on March 18 evening and why?",
    model:"They were very happy because the enemy warships were leaving and could not break through.",
    highlights:["Turkish commanders were very happy","They left our coast. They could not break through"], hint:"Paragraph C."},
  { prompt:"Which dates in the text help build the timeline of events?",
    model:"1909 (he became a soldier), 1915 (still serving), and March 18 (evening of the victory).",
    highlights:["became a soldier in 1909","serving ... in 1915","In the evening of March 18"], hint:"Across text."},
  { prompt:"What qualities of Seyit can you infer from his actions?",
    model:"Strength, bravery, love for his country, and determination under extreme conditions.",
    highlights:["tall and strong man","His love for his country helped him"], hint:"Paragraph B."},
  { prompt:"Why was the single cannon important in the story?",
    model:"It was the only cannon in good condition and enabled the decisive shot that sank Ocean.",
    highlights:["only one cannon in good condition","sank it"], hint:"Paragraph B."},
  { prompt:"Quote or paraphrase the message in Cevat Pa≈üa‚Äôs words.",
    model:"He declared that the enemy had left and would not break through the Turkish defenses.",
    highlights:["They left our coast. They could not break through","They will not break through"], hint:"Paragraph C."}
];

/* =========================
   STATE & DOM
   ========================= */
let currentSlide = 0;
let totalSlides = 3 + TF_QUESTIONS.length + MCQ_QUESTIONS.length + FILL_QUESTIONS.length + OPEN_QUESTIONS.length + 1;
let speechSynthesisObj = window.speechSynthesis;
let speechUtterance = null;
let isReading = false, isPaused = false;
let currentQuestionText = "";
let score = 0;

let activeHighlights = [];

const readingDiv = document.getElementById('reading');
const readingContentDiv = document.getElementById('readingContent');
const qboxDiv = document.getElementById('qbox');
const vocabGridDiv = document.getElementById('vocabGrid');
const vocabGameContainerDiv = document.getElementById('vocabGameContainer');
const completionDiv = document.getElementById('completion');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const pageIndicator = document.getElementById('pageIndicator');
const readBtn = document.getElementById('readBtn');
const pauseBtn = document.getElementById('pauseBtn');
const resumeBtn = document.getElementById('resumeBtn');
const stopBtn = document.getElementById('stopBtn');
const fullscreenBtn = document.getElementById('fullscreenBtn');
const restartBtn = document.getElementById('restartBtn');
const themeSelector = document.getElementById('themeSelector');
const voiceSelector = document.getElementById('voiceSelector');
const scoreDisplay = document.getElementById('score');
const finalScoreDisplay = document.getElementById('finalScore');
const progressBar = document.getElementById('progressBar');

/* Themes */
const THEMES={'dark-blue':'theme-dark-blue','light':'theme-light','nature':'theme-nature','tech':'theme-tech'};
function applyTheme(name){document.body.className=THEMES[name]||'';localStorage.setItem('selectedTheme',name)}
function initTheme(){
  const saved=localStorage.getItem('selectedTheme');
  if(saved){themeSelector.value=saved;applyTheme(saved)}
  themeSelector.addEventListener('change',e=>applyTheme(e.target.value))
}

/* Progress bar */
function updateProgressBar(){
  const progress=(currentSlide/(totalSlides-1))*100;
  progressBar.style.width=`${progress}%`;
}

/* INIT */
function init(){
  showSlide(currentSlide);
  setupEventListeners();
  initTheme();
  setupFullscreenListener();
  updateProgressBar();
  initVoices();
}

/* Listeners */
function setupEventListeners(){
  prevBtn.addEventListener('click',()=>{ if(currentSlide>0){ currentSlide--; showSlide(currentSlide);} });
  nextBtn.addEventListener('click',()=>{ if(currentSlide<totalSlides-1){ currentSlide++; showSlide(currentSlide);} });
  readBtn.addEventListener('click',startReading);
  pauseBtn.addEventListener('click',pauseReading);
  resumeBtn.addEventListener('click',resumeReading);
  stopBtn.addEventListener('click',stopReading);
  fullscreenBtn.addEventListener('click',toggleFullscreen);
  restartBtn.addEventListener('click',()=>{ score=0; scoreDisplay.textContent=score; currentSlide=0; showSlide(currentSlide); });

  document.addEventListener('keydown',e=>{
    if(e.key==='ArrowLeft'&&currentSlide>0){ currentSlide--; showSlide(currentSlide); }
    else if(e.key==='ArrowRight'&&currentSlide<totalSlides-1){ currentSlide++; showSlide(currentSlide); }
    else if(e.key.toLowerCase()==='f'){ toggleFullscreen(); }
  });

  const savedVoice=localStorage.getItem('voicePref');
  if(savedVoice){ voiceSelector.value=savedVoice; }
  voiceSelector.addEventListener('change',()=>localStorage.setItem('voicePref',voiceSelector.value));
}

/* Fullscreen */
function setupFullscreenListener(){
  document.addEventListener('fullscreenchange',handleFullscreenChange);
  document.addEventListener('webkitfullscreenchange',handleFullscreenChange);
  document.addEventListener('mozfullscreenchange',handleFullscreenChange);
  document.addEventListener('MSFullscreenChange',handleFullscreenChange);
}
function handleFullscreenChange(){
  if(document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement){
    document.body.classList.add('fullscreen-mode');
  }else{
    document.body.classList.remove('fullscreen-mode');
  }
}

/* Slides */
function showSlide(slideIndex){
  readingDiv.style.display='none';
  qboxDiv.style.display='none';
  vocabGridDiv.style.display='none';
  vocabGameContainerDiv.style.display='none';
  completionDiv.style.display='none';

  stopReading();
  activeHighlights = [];
  readingContentDiv.innerHTML = PASSAGE;

  pageIndicator.textContent=`Page ${slideIndex+1}`;
  updateProgressBar();

  if(slideIndex===0){
    vocabGridDiv.style.display='grid';
    showVocabulary();
  }else if(slideIndex===1){
    vocabGameContainerDiv.style.display='flex';
    showVocabGame();
  }else if(slideIndex===2){
    readingDiv.style.display='block';
  }else if(slideIndex===totalSlides-1){
    completionDiv.style.display='flex';
    finalScoreDisplay.textContent=score;
  }else{
    readingDiv.style.display='block';
    qboxDiv.style.display='block';

    const questionIndex=slideIndex-3;
    if(questionIndex<TF_QUESTIONS.length){
      showTFQuestion(TF_QUESTIONS[questionIndex]);
    }else if(questionIndex<TF_QUESTIONS.length+MCQ_QUESTIONS.length){
      const mcqIndex=questionIndex-TF_QUESTIONS.length;
      showMCQQuestion(MCQ_QUESTIONS[mcqIndex]);
    }else if(questionIndex<TF_QUESTIONS.length+MCQ_QUESTIONS.length+FILL_QUESTIONS.length){
      const fillIndex=questionIndex-TF_QUESTIONS.length-MCQ_QUESTIONS.length;
      showFillQuestion(FILL_QUESTIONS[fillIndex]);
    }else{
      const openIndex=questionIndex-TF_QUESTIONS.length-MCQ_QUESTIONS.length-FILL_QUESTIONS.length;
      showOpenQuestion(OPEN_QUESTIONS[openIndex]);
    }
  }
}

/* Vocab Cards */
function showVocabulary(){
  vocabGridDiv.innerHTML='';
  VOCAB_LIST.forEach(([en,tr])=>{
    const card=document.createElement('div');
    card.className='vocab-card'; card.textContent=en;
    card.addEventListener('click',function(){
      if(!this.classList.contains('flipped')){ this.classList.add('flipped'); this.textContent=tr; }
      else{ this.classList.remove('flipped'); this.textContent=en; }
    });
    vocabGridDiv.appendChild(card);
  });
}

/* Vocab Matching Game */
let selectedEnglishCard=null, matchedPairs=new Set(), usedVocabIndices=new Set(), currentVocabGameWords=[];
function getRandomVocabWords(count){
  const available=[]; for(let i=0;i<VOCAB_LIST.length;i++) if(!usedVocabIndices.has(i)) available.push(i);
  if(available.length===0){ usedVocabIndices.clear(); for(let i=0;i<VOCAB_LIST.length;i++) available.push(i); }
  const actual=Math.min(count,available.length); const selected=[];
  for(let i=0;i<actual;i++){ const idx=Math.floor(Math.random()*available.length); const pick=available[idx]; selected.push(pick); usedVocabIndices.add(pick); available.splice(idx,1); }
  return selected.map(i=>VOCAB_LIST[i]);
}
function showVocabGame(){
  selectedEnglishCard=null; matchedPairs.clear();
  currentVocabGameWords=getRandomVocabWords(10);
  vocabGameContainerDiv.innerHTML="";
  const englishColumn=document.createElement('div'); englishColumn.className='vocab-game-column';
  const turkishColumn=document.createElement('div'); turkishColumn.className='vocab-game-column';

  currentVocabGameWords.forEach((pair,index)=>{
    const card=document.createElement('div'); card.className='vocab-game-card'; card.textContent=pair[0];
    card.dataset.index=index; card.dataset.type='english'; card.addEventListener('click',handleCardClick);
    englishColumn.appendChild(card);
  });

  const shuffled=currentVocabGameWords.map((p,idx)=>({word:p[1],originalIndex:idx})).sort(()=>Math.random()-0.5);
  shuffled.forEach(item=>{
    const card=document.createElement('div'); card.className='vocab-game-card'; card.textContent=item.word;
    card.dataset.index=item.originalIndex; card.dataset.type='turkish'; card.addEventListener('click',handleCardClick);
    turkishColumn.appendChild(card);
  });

  vocabGameContainerDiv.appendChild(englishColumn);
  vocabGameContainerDiv.appendChild(turkishColumn);
}
function handleCardClick(e){
  const card=e.target; const type=card.dataset.type; const index=parseInt(card.dataset.index);
  if(matchedPairs.has(index)) return;
  if(type==='english'){
    if(selectedEnglishCard) selectedEnglishCard.classList.remove('selected');
    card.classList.add('selected'); selectedEnglishCard=card;
  }else if(type==='turkish'){
    if(!selectedEnglishCard) return;
    const englishIndex=parseInt(selectedEnglishCard.dataset.index);
    if(englishIndex===index){
      card.classList.add('matched'); selectedEnglishCard.classList.add('matched'); matchedPairs.add(index);
      score+=10; scoreDisplay.textContent=score;
      selectedEnglishCard.classList.remove('selected'); selectedEnglishCard=null;
      if(matchedPairs.size===currentVocabGameWords.length){
        setTimeout(()=>{
          vocabGameContainerDiv.innerHTML=`<div class="game-message">üéâ All matched!</div>
          <div class="game-controls"><button id="playAgainBtn">üîÑ Play Again</button></div>`;
          document.getElementById('playAgainBtn').addEventListener('click',showVocabGame);
        },400);
      }
    }else{
      card.classList.add('incorrect'); selectedEnglishCard.classList.add('incorrect');
      setTimeout(()=>{
        card.classList.remove('incorrect'); selectedEnglishCard.classList.remove('incorrect'); selectedEnglishCard.classList.remove('selected'); selectedEnglishCard=null;
      },700);
    }
  }
}

/* ===== Question Renders (Show Answer -> addHighlights from PASSAGE) ===== */
function showTFQuestion(q){
  currentQuestionText=q.prompt;
  qboxDiv.innerHTML=`
    <div class="question">${q.prompt}</div>
    <div class="options">
      <div class="option" data-value="True">True</div>
      <div class="option" data-value="False">False</div>
    </div>
    <div class="button-group">
      <button id="showAnswerBtn">üí° Show Answer</button>
      <button id="showHintBtn">üí¨ Hint</button>
    </div>
    <div class="answer" id="answerDiv"></div>
    <div class="hint" id="hintDiv"></div>
  `;
  const answerDiv=document.getElementById('answerDiv');
  const hintDiv=document.getElementById('hintDiv');
  document.querySelectorAll('.option').forEach(opt=>opt.addEventListener('click',function(){document.querySelectorAll('.option').forEach(o=>o.classList.remove('selected')); this.classList.add('selected');}));
  document.getElementById('showAnswerBtn').addEventListener('click',()=>{
    answerDiv.textContent=`Answer: ${q.answer}`; answerDiv.style.display='block';
    addHighlights(q.highlights);
  });
  document.getElementById('showHintBtn').addEventListener('click',()=>{ hintDiv.textContent=`üí° Hint: ${q.hint}`; hintDiv.style.display='block'; });
}

function showMCQQuestion(q){
  currentQuestionText=q.prompt;
  let optionsHTML=''; q.options.forEach((opt,idx)=>optionsHTML+=`<div class="option" data-value="${idx}">${opt}</div>`);
  qboxDiv.innerHTML=`
    <div class="question">${q.prompt}</div>
    <div class="options">${optionsHTML}</div>
    <div class="button-group">
      <button id="showAnswerBtn">üí° Show Answer</button>
      <button id="showHintBtn">üí¨ Hint</button>
    </div>
    <div class="answer" id="answerDiv"></div>
    <div class="hint" id="hintDiv"></div>
  `;
  const answerDiv=document.getElementById('answerDiv');
  const hintDiv=document.getElementById('hintDiv');
  document.querySelectorAll('.option').forEach(opt=>opt.addEventListener('click',function(){document.querySelectorAll('.option').forEach(o=>o.classList.remove('selected')); this.classList.add('selected');}));
  document.getElementById('showAnswerBtn').addEventListener('click',()=>{
    answerDiv.textContent=`Answer: ${q.options[q.answer]}`; answerDiv.style.display='block';
    addHighlights(q.highlights);
  });
  document.getElementById('showHintBtn').addEventListener('click',()=>{ hintDiv.textContent=`üí° Hint: ${q.hint}`; hintDiv.style.display='block'; });
}

function showFillQuestion(q){
  currentQuestionText=q.prompt;
  qboxDiv.innerHTML=`
    <div class="question">${q.prompt}</div>
    <input type="text" id="fillAnswer" placeholder="Type your answer here"/>
    <div class="button-group">
      <button id="showAnswerBtn">üí° Show Answer</button>
      <button id="showHintBtn">üí¨ Hint</button>
    </div>
    <div class="answer" id="answerDiv"></div>
    <div class="hint" id="hintDiv"></div>
  `;
  const answerDiv=document.getElementById('answerDiv');
  const hintDiv=document.getElementById('hintDiv');
  document.getElementById('showAnswerBtn').addEventListener('click',()=>{
    answerDiv.textContent=`Answer: ${q.answer}`; answerDiv.style.display='block';
    addHighlights(q.highlights);
  });
  document.getElementById('showHintBtn').addEventListener('click',()=>{ hintDiv.textContent=`üí° Hint: ${q.hint}`; hintDiv.style.display='block'; });
}

function showOpenQuestion(q){
  currentQuestionText=q.prompt;
  qboxDiv.innerHTML=`
    <div class="question">${q.prompt}</div>
    <textarea id="openAnswer" placeholder="Type your answer here" rows="4"></textarea>
    <div class="button-group">
      <button id="showAnswerBtn">üí° Show Model Answer</button>
      <button id="showHintBtn">üí¨ Hint</button>
    </div>
    <div class="answer" id="answerDiv"></div>
    <div class="hint" id="hintDiv"></div>
  `;
  const answerDiv=document.getElementById('answerDiv');
  const hintDiv=document.getElementById('hintDiv');
  document.getElementById('showAnswerBtn').addEventListener('click',()=>{
    answerDiv.textContent=`Model Answer: ${q.model}`; answerDiv.style.display='block';
    addHighlights(q.highlights);
  });
  document.getElementById('showHintBtn').addEventListener('click',()=>{ hintDiv.textContent=`üí° Hint: ${q.hint}`; hintDiv.style.display='block'; });
}

/* ===== Sally-Style Highlight (ROBUST FINAL VERSION) ===== */
function escapeRegExp(s){ return s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'); }
function addHighlights(phrases){
  let html = PASSAGE;
  const sorted = [...phrases].filter(Boolean).sort((a, b) => b.length - a.length);

  sorted.forEach(phrase => {
    // This function builds a highly flexible regex pattern from a phrase.
    const buildPattern = (p) => {
      const parts = p.split(/\s+/); // Split phrase into words/parts
      const regexParts = parts.map(part => {
        // Handle the ellipsis wildcard
        if (part === '...') {
          return '[\\s\\S]*?'; // Match any non-greedy sequence of non-whitespace characters
        }
        // For other words, escape them and allow for optional HTML tags/whitespace
        return `${escapeRegExp(part)}(?:<[^>]*>)?\\s*`;
      });
      return regexParts.join('');
    };

    const finalPattern = buildPattern(phrase);
    const rx = new RegExp(`(${finalPattern})`, 'gi');
    html = html.replace(rx, '<span class="highlight">$1</span>');
  });

  readingContentDiv.innerHTML = html;

  const first = readingContentDiv.querySelector('.highlight');
  if(first){
    first.scrollIntoView({behavior:'smooth', block:'center'});
  }
}

/* TTS */
let cachedVoices=[];
function initVoices(){
  function load(){ cachedVoices=speechSynthesis.getVoices(); }
  load();
  if(typeof speechSynthesis!=="undefined"){ speechSynthesis.onvoiceschanged=load; }
}
function pickEnUSVoice(preferMale=false){
  const enUS=cachedVoices.filter(v=>/en[-_]?US/i.test(v.lang||"")||/English \(United States\)/i.test(v.name||""));
  const femaleHints=["Female","Aria","Jenny","Samantha","Zira","Google US English","Ana"];
  const maleHints=["Male","Guy","David","Mark","Christopher","Eric","John"];
  const hints=preferMale?maleHints:femaleHints;
  const hit=enUS.find(v=>hints.some(h=>(v.name||"").toLowerCase().includes(h.toLowerCase())));
  if(hit) return hit;
  if(enUS.length) return enUS[0];
  const enAny=cachedVoices.filter(v=>/^en/i.test(v.lang||""));
  if(enAny.length) return enAny[0];
  return null;
}
function startReading(){
  if(isReading&&!isPaused) return;
  if(isPaused){ resumeReading(); return; }
  let textToRead="";
  if(currentSlide>=3&&currentSlide<totalSlides-1) textToRead=currentQuestionText;
  else textToRead=readingContentDiv.innerText;
  speechUtterance=new SpeechSynthesisUtterance(textToRead);
  const preferMale=(voiceSelector.value==='male');
  const voice=pickEnUSVoice(preferMale); if(voice) speechUtterance.voice=voice;
  speechUtterance.lang='en-US'; speechUtterance.rate=.95;
  speechUtterance.onend=()=>{ stopReading(); };
  speechSynthesisObj.speak(speechUtterance);
  isReading=true; isPaused=false;
  readBtn.style.display='none'; pauseBtn.style.display='inline-block'; stopBtn.style.display='inline-block';
}
function pauseReading(){ if(!isReading||isPaused) return; speechSynthesisObj.pause(); isPaused=true; pauseBtn.style.display='none'; resumeBtn.style.display='inline-block';}
function resumeReading(){ if(!isReading||!isPaused) return; speechSynthesisObj.resume(); isPaused=false; resumeBtn.style.display='none'; pauseBtn.style.display='inline-block';}
function stopReading(){
  if(!isReading) return;
  speechSynthesisObj.cancel(); isReading=false; isPaused=false;
  readBtn.style.display='inline-block'; pauseBtn.style.display='none'; resumeBtn.style.display='none'; stopBtn.style.display='none';
}

/* Fullscreen */
function toggleFullscreen(){ if(!document.fullscreenElement) document.documentElement.requestFullscreen().catch(()=>{}); else document.exitFullscreen(); }

/* Start */
document.addEventListener('DOMContentLoaded',()=>{ readingContentDiv.innerHTML=PASSAGE; init(); });
</script>
</body>
</html>