<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>EGH - YÃ¶netim Paneli</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-color: #f4f7f6; font-family: 'Segoe UI', sans-serif; }
        .container-fluid { max-width: 1600px; margin-top: 20px; }
        
        /* DeÄŸiÅŸiklik ve Silme Efektleri */
        .changed-row { background-color: #fff8c4 !important; transition: 0.5s; }
        .deleted-row { background-color: #ffcccc !important; text-decoration: line-through; opacity: 0.5; pointer-events: none; }
        
        /* Form ElemanlarÄ± */
        .table select, .table input { border: 1px solid #ced4da; font-size: 0.9rem; }
        
        /* Silme Butonu */
        .btn-delete { color: #dc3545; border: 1px solid #dc3545; transition: 0.3s; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; }
        .btn-delete:hover { background-color: #dc3545; color: white; }

        /* TÃ¼r Renkleri */
        .type-Games { color: #d63384; font-weight: bold; }
        .type-Videos { color: #dc3545; font-weight: bold; }
        .type-Vocabulary { color: #198754; font-weight: bold; }
        .type-Grammar { color: #fd7e14; font-weight: bold; }
        .type-Documents { color: #0dcaf0; font-weight: bold; }
        .type-Slides { color: #212529; font-weight: bold; }
    </style>
</head>
<body>

<div class="container-fluid mb-5">
    <div class="d-flex justify-content-between align-items-center bg-white p-3 rounded shadow-sm mb-4">
        <h4 class="m-0 text-primary"><i class="fa-solid fa-sliders"></i> Ä°Ã§erik YÃ¶netimi</h4>
        <div>
            <span id="statusMsg" class="me-3 fw-bold text-success"></span>
            <button class="btn btn-outline-secondary me-2" onclick="loadData()"><i class="fa-solid fa-rotate"></i> Yenile</button>
            <button class="btn btn-success" onclick="saveChanges()"><i class="fa-solid fa-floppy-disk"></i> DeÄŸiÅŸiklikleri Kaydet</button>
        </div>
    </div>

    <div id="loginSection" class="row justify-content-center mt-5">
        <div class="col-md-4 text-center">
            <div class="card p-4 shadow">
                <h5>ðŸ”‘ YÃ¶netici GiriÅŸi</h5>
                <p class="text-muted small">KullanÄ±cÄ±: abdullahaydinhan<br>Repo: englishgamehub</p>
                <input type="password" id="githubToken" class="form-control mb-3" placeholder="GitHub Token YapÄ±ÅŸtÄ±r...">
                <button class="btn btn-primary w-100" onclick="verifyAndLoad()">GiriÅŸ Yap</button>
            </div>
        </div>
    </div>

    <div id="loader" class="text-center mt-5" style="display:none;">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
        <h5 class="mt-3 text-muted" id="loaderText">Ä°ÅŸlem yapÄ±lÄ±yor...</h5>
    </div>

    <div id="tableSection" style="display:none;" class="card shadow-sm">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th width="3%" class="text-center">Sil</th>
                        <th width="3%" class="text-center">Aktif</th>
                        <th width="3%" class="text-center">Fav</th>
                        <th width="8%">SÄ±nÄ±f</th>
                        <th width="10%">Ãœnite</th>
                        <th width="12%">TÃ¼r</th>
                        <th width="20%">GÃ¶rÃ¼nen BaÅŸlÄ±k</th>
                        <th width="20%">AÃ§Ä±klama</th>
                        <th width="15%" class="text-muted small">Dosya Yolu</th>
                    </tr>
                </thead>
                <tbody id="gameTableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<datalist id="themeList">
    <option value="Theme 1"><option value="Theme 2"><option value="Theme 3"><option value="Theme 4">
    <option value="Theme 5"><option value="Theme 6"><option value="Theme 7"><option value="Theme 8">
    <option value="Revision"><option value="General">
</datalist>

<script>
    // --- AYARLAR ---
    const GITHUB_USERNAME = "abdullahaydinhan";
    const REPO_NAME = "englishgamehub";
    const FILE_PATH = "games_data.json";

    let currentData = [];
    let fileSha = "";

    const typeOptions = [
        { val: "Games", label: "ðŸŽ® Game" },
        { val: "Interactive_Activities", label: "ðŸ§© Activity" },
        { val: "Videos", label: "ðŸŽ¬ Video" },
        { val: "Vocabulary", label: "ðŸ“– Vocabulary" },
        { val: "Grammar", label: "âœï¸ Grammar" },
        { val: "Documents", label: "ðŸ“„ Document" },
        { val: "Slides", label: "ðŸ“Š Slide" }
    ];

    // Token HafÄ±zasÄ±
    document.getElementById('githubToken').value = localStorage.getItem('gh_token') || "";

    function verifyAndLoad() {
        const token = document.getElementById('githubToken').value;
        if(!token) return alert("LÃ¼tfen Token giriniz!");
        localStorage.setItem('gh_token', token);
        loadData();
    }

    function showLoader(show, text = "Ä°ÅŸlem yapÄ±lÄ±yor...") {
        document.getElementById('loader').style.display = show ? 'block' : 'none';
        document.getElementById('loaderText').innerText = text;
        if(show) document.getElementById('tableSection').style.opacity = '0.2';
        else document.getElementById('tableSection').style.opacity = '1';
    }

    // VERÄ° Ã‡EKME
    async function loadData() {
        showLoader(true, "Veriler Ã§ekiliyor...");
        const token = localStorage.getItem('gh_token');
        try {
            const res = await fetch(`https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/contents/${FILE_PATH}`, {
                headers: { 'Authorization': `token ${token}` }
            });
            if (!res.ok) throw new Error("Veri Ã§ekilemedi! Token hatalÄ± olabilir.");
            
            const data = await res.json();
            fileSha = data.sha;
            currentData = JSON.parse(decodeURIComponent(escape(window.atob(data.content))));
            currentData.reverse(); 

            renderTable();
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('tableSection').style.display = 'block';
        } catch (e) { alert(e.message); }
        finally { showLoader(false); }
    }

    // TABLO OLUÅžTURMA
    function renderTable() {
        const tbody = document.getElementById('gameTableBody');
        tbody.innerHTML = "";

        currentData.forEach((item, index) => {
            const tr = document.createElement('tr');
            tr.id = `row-${index}`;
            
            // TÃ¼r Select
            let typeSelect = `<select class="form-select form-select-sm type-${item.source}" onchange="updateRow(${index}, 'source', this.value)">`;
            typeOptions.forEach(t => {
                typeSelect += `<option value="${t.val}" ${item.source === t.val ? 'selected' : ''}>${t.label}</option>`;
            });
            typeSelect += `</select>`;

            // SÄ±nÄ±f Select
            let gradeSelect = `<select class="form-select form-select-sm" onchange="updateRow(${index}, 'grade', this.value)">
                ${["9TH_GRADE","10TH_GRADE","11TH_GRADE","12TH_GRADE"].map(g => `<option value="${g}" ${item.grade===g?'selected':''}>${g}</option>`).join('')}
            </select>`;

            tr.innerHTML = `
                <td class="text-center">
                    <button class="btn btn-sm btn-delete rounded-circle" onclick="deleteItem(${index})" title="Tamamen Sil">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </td>
                <td class="text-center"><input class="form-check-input" type="checkbox" onchange="updateRow(${index}, 'isVisible', this.checked)" ${item.isVisible !== false ? 'checked' : ''}></td>
                <td class="text-center"><input type="checkbox" onchange="updateRow(${index}, 'isFeatured', this.checked)" ${item.isFeatured ? 'checked' : ''}></td>
                <td>${gradeSelect}</td>
                <td><input type="text" list="themeList" class="form-control form-control-sm" value="${item.unit || ''}" onchange="updateRow(${index}, 'unit', this.value)"></td>
                <td>${typeSelect}</td>
                <td><input type="text" class="form-control fw-bold" value="${item.title || ''}" onchange="updateRow(${index}, 'title', this.value)"></td>
                <td><input type="text" class="form-control form-control-sm" value="${item.description || ''}" onchange="updateRow(${index}, 'description', this.value)"></td>
                <td class="text-muted small text-truncate" style="max-width: 150px;" title="${item.path}">${item.name}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    window.updateRow = function(index, key, value) {
        currentData[index][key] = value;
        document.getElementById(`row-${index}`).classList.add('changed-row');
        document.getElementById('statusMsg').innerText = "DeÄŸiÅŸiklik yapÄ±ldÄ±, kaydetmeyi unutma!";
    }

    // --- SÄ°LME MANTIÄžI ---
    async function deleteItem(index) {
        const item = currentData[index];
        const isGame = item.source === 'Games';
        let confirmMsg = `"${item.name}" dosyasÄ±nÄ± GitHub'dan TAMAMEN silmek Ã¼zeresiniz.`;
        
        if(isGame) {
            confirmMsg += `\n\nâš ï¸ DÄ°KKAT: Bu bir Oyun klasÃ¶rÃ¼dÃ¼r!\n"index.html" dosyasÄ±nÄ±n bulunduÄŸu TÃœM KLASÃ–R silinecektir.`;
        } else {
            confirmMsg += `\n\nBu iÅŸlem geri alÄ±namaz.`;
        }

        if(!confirm(confirmMsg)) return;

        showLoader(true, "Dosya(lar) GitHub'dan siliniyor...");
        const token = localStorage.getItem('gh_token');

        try {
            if (isGame) {
                // Oyun KlasÃ¶rÃ¼ Silme: KlasÃ¶r yolunu bul ve iÃ§indekileri sil
                const pathParts = item.path.split('/');
                pathParts.pop(); // index.html'i Ã§Ä±kar
                const folderPath = pathParts.join('/'); 

                const listRes = await fetch(`https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/contents/${folderPath}`, {
                    headers: { 'Authorization': `token ${token}` }
                });
                
                if(!listRes.ok) throw new Error("KlasÃ¶r iÃ§eriÄŸi okunamadÄ±.");
                const files = await listRes.json();

                for (const file of files) {
                    await deleteSingleFile(file.path, file.sha, token);
                }

            } else {
                // Tek Dosya Silme (PDF, Video vb.)
                const fileRes = await fetch(`https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/contents/${item.path}`, {
                    headers: { 'Authorization': `token ${token}` }
                });
                if(!fileRes.ok) throw new Error("Dosya bulunamadÄ±.");
                const fileData = await fileRes.json();
                
                await deleteSingleFile(item.path, fileData.sha, token);
            }

            // BaÅŸarÄ±lÄ± olursa satÄ±rÄ± Ã§iz
            document.getElementById(`row-${index}`).classList.add('deleted-row');
            alert("âœ… Silme iÅŸlemi baÅŸarÄ±lÄ±! Site birkaÃ§ dakika iÃ§inde gÃ¼ncellenecek.");

        } catch (e) {
            alert("Hata oluÅŸtu: " + e.message);
        } finally {
            showLoader(false);
        }
    }

    async function deleteSingleFile(path, sha, token) {
        const res = await fetch(`https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/contents/${path}`, {
            method: 'DELETE',
            headers: { 
                'Authorization': `token ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                message: `Deleted via Admin Panel: ${path}`,
                sha: sha
            })
        });
        if(!res.ok) throw new Error(`${path} silinemedi.`);
    }

    // --- DEÄžÄ°ÅžÄ°KLÄ°KLERÄ° KAYDETME ---
    async function saveChanges() {
        if (!confirm("DeÄŸiÅŸiklikler siteye gÃ¶nderilsin mi?")) return;
        showLoader(true, "Ayarlar kaydediliyor...");
        
        // Silinen satÄ±rlarÄ± veriden Ã§Ä±kararak kaydet
        // (Ekrandaki Ã§izili olanlarÄ± backend'e gÃ¶nderme)
        // Not: Ancak gerÃ§ek silme iÅŸlemi zaten yapÄ±ldÄ±, bu sadece json'u gÃ¼nceller.
        // AslÄ±nda Robot (Action) zaten Ã§alÄ±ÅŸÄ±p json'u dÃ¼zeltecek. 
        // Biz yine de metadata gÃ¼ncellemeleri iÃ§in gÃ¶nderiyoruz.
        
        const dataToSave = [...currentData].reverse(); 
        const token = localStorage.getItem('gh_token');
        
        const bodyData = {
            message: "Admin Update via Panel ðŸš€",
            content: window.btoa(unescape(encodeURIComponent(JSON.stringify(dataToSave, null, 2)))),
            sha: fileSha
        };

        try {
            const res = await fetch(`https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/contents/${FILE_PATH}`, {
                method: 'PUT',
                headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify(bodyData)
            });
            if (!res.ok) throw new Error("Kaydetme hatasÄ±!");
            const data = await res.json();
            fileSha = data.content.sha;
            document.querySelectorAll('.changed-row').forEach(row => row.classList.remove('changed-row'));
            alert("âœ… Ayarlar gÃ¼ncellendi!");
        } catch (e) { alert(e.message); }
        finally { showLoader(false); }
    }
</script>
</body>
</html>
