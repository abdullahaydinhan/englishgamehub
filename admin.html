<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>EGH - SÃ¼per YÃ¶netim Paneli</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-color: #f4f7f6; font-family: 'Segoe UI', sans-serif; }
        .container-fluid { max-width: 1600px; margin-top: 20px; }
        .changed-row { background-color: #fff8c4 !important; }
        .table select, .table input { border: 1px solid #ced4da; font-size: 0.9rem; }
        /* TÃ¼rlere gÃ¶re renkli etiketler */
        .type-Games { color: #d63384; font-weight: bold; }
        .type-Videos { color: #dc3545; font-weight: bold; }
        .type-Vocabulary { color: #198754; font-weight: bold; }
        .type-Grammar { color: #fd7e14; font-weight: bold; }
        .type-Documents { color: #0dcaf0; font-weight: bold; }
        .type-Slides { color: #6f42c1; font-weight: bold; }
    </style>
</head>
<body>

<div class="container-fluid mb-5">
    <div class="d-flex justify-content-between align-items-center bg-white p-3 rounded shadow-sm mb-4">
        <h4 class="m-0 text-primary"><i class="fa-solid fa-sliders"></i> Ä°Ã§erik YÃ¶netimi</h4>
        <div>
            <span id="statusMsg" class="me-3 fw-bold text-success"></span>
            <button class="btn btn-outline-secondary me-2" onclick="loadData()"><i class="fa-solid fa-rotate"></i> Yenile</button>
            <button class="btn btn-success" onclick="saveChanges()"><i class="fa-solid fa-floppy-disk"></i> DeÄŸiÅŸiklikleri Kaydet</button>
        </div>
    </div>

    <div id="loginSection" class="row justify-content-center mt-5">
        <div class="col-md-4 text-center">
            <div class="card p-4 shadow">
                <h5>ðŸ”‘ YÃ¶netici GiriÅŸi</h5>
                <input type="password" id="githubToken" class="form-control mb-3" placeholder="GitHub Token...">
                <button class="btn btn-primary w-100" onclick="verifyAndLoad()">GiriÅŸ Yap</button>
            </div>
        </div>
    </div>

    <div id="tableSection" style="display:none;" class="card shadow-sm">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th width="3%" class="text-center">Aktif</th>
                        <th width="3%" class="text-center">Fav</th>
                        <th width="8%">SÄ±nÄ±f</th>
                        <th width="12%">Ãœnite (SeÃ§/Yaz)</th>
                        <th width="12%">TÃ¼r</th>
                        <th width="20%">GÃ¶rÃ¼nen BaÅŸlÄ±k</th>
                        <th width="20%">AÃ§Ä±klama</th>
                        <th width="15%" class="text-muted small">Dosya Yolu</th>
                    </tr>
                </thead>
                <tbody id="gameTableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<datalist id="themeList">
    <option value="Theme 1">
    <option value="Theme 2">
    <option value="Theme 3">
    <option value="Theme 4">
    <option value="Theme 5">
    <option value="Theme 6">
    <option value="Theme 7">
    <option value="Theme 8">
    <option value="Revision">
    <option value="General">
</datalist>

<script>
    // --- AYARLAR ---
    const GITHUB_USERNAME = "hunter5234"; 
    const REPO_NAME = "english-game-hub";
    const FILE_PATH = "games_data.json";

    let currentData = [];
    let fileSha = "";

    // TÃœR SEÃ‡ENEKLERÄ°
    const typeOptions = [
        { val: "Games", label: "ðŸŽ® Game" },
        { val: "Videos", label: "ðŸŽ¬ Video" },
        { val: "Vocabulary", label: "ðŸ“– Vocabulary" },
        { val: "Grammar", label: "âœï¸ Grammar" },
        { val: "Documents", label: "ðŸ“„ Document" },
        { val: "Slides", label: "ðŸ“Š Slide" }
    ];

    document.getElementById('githubToken').value = localStorage.getItem('gh_token') || "";

    function verifyAndLoad() {
        const token = document.getElementById('githubToken').value;
        if(!token) return alert("Token gerekli!");
        localStorage.setItem('gh_token', token);
        loadData();
    }

    async function loadData() {
        const token = localStorage.getItem('gh_token');
        try {
            const res = await fetch(`https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/contents/${FILE_PATH}`, {
                headers: { 'Authorization': `token ${token}` }
            });
            if (!res.ok) throw new Error("Veri Ã§ekilemedi");
            
            const data = await res.json();
            fileSha = data.sha;
            currentData = JSON.parse(decodeURIComponent(escape(window.atob(data.content))));
            
            // YENÄ°DEN ESKÄ°YE SIRALAMA (Array'i ters Ã§eviriyoruz ki en yeni en Ã¼stte olsun)
            currentData.reverse();

            renderTable();
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('tableSection').style.display = 'block';
        } catch (e) { alert(e.message); }
    }

    function renderTable() {
        const tbody = document.getElementById('gameTableBody');
        tbody.innerHTML = "";

        currentData.forEach((item, index) => {
            const tr = document.createElement('tr');
            
            // TÃœR SELECT
            let typeSelect = `<select class="form-select form-select-sm type-${item.source}" onchange="updateRow(${index}, 'source', this.value)">`;
            typeOptions.forEach(t => {
                typeSelect += `<option value="${t.val}" ${item.source === t.val ? 'selected' : ''}>${t.label}</option>`;
            });
            typeSelect += `</select>`;

            // SINIF SELECT
            let gradeSelect = `<select class="form-select form-select-sm" onchange="updateRow(${index}, 'grade', this.value)">
                ${["9TH_GRADE","10TH_GRADE","11TH_GRADE","12TH_GRADE"].map(g => `<option value="${g}" ${item.grade===g?'selected':''}>${g}</option>`).join('')}
            </select>`;

            tr.innerHTML = `
                <td class="text-center">
                    <input class="form-check-input" type="checkbox" onchange="updateRow(${index}, 'isVisible', this.checked)" ${item.isVisible !== false ? 'checked' : ''}>
                </td>
                <td class="text-center">
                    <input type="checkbox" onchange="updateRow(${index}, 'isFeatured', this.checked)" ${item.isFeatured ? 'checked' : ''}>
                </td>
                <td>${gradeSelect}</td>
                <td>
                    <input type="text" list="themeList" class="form-control form-control-sm" value="${item.unit || ''}" placeholder="SeÃ§ veya Yaz" onchange="updateRow(${index}, 'unit', this.value)">
                </td>
                <td>${typeSelect}</td>
                <td>
                    <input type="text" class="form-control fw-bold" value="${item.title || ''}" onchange="updateRow(${index}, 'title', this.value)">
                </td>
                <td>
                    <input type="text" class="form-control form-control-sm" value="${item.description || ''}" placeholder="AÃ§Ä±klama..." onchange="updateRow(${index}, 'description', this.value)">
                </td>
                <td class="text-muted small text-truncate" style="max-width: 150px;" title="${item.path}">
                    ${item.name}
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    window.updateRow = function(index, key, value) {
        currentData[index][key] = value;
        document.getElementById('gameTableBody').children[index].classList.add('changed-row');
        document.getElementById('statusMsg').innerText = "DeÄŸiÅŸiklik yapÄ±ldÄ±, kaydetmeyi unutma!";
    }

    async function saveChanges() {
        if (!confirm("DeÄŸiÅŸiklikler yayÄ±nlansÄ±n mÄ±?")) return;
        
        // Kaydederken tekrar eskiye doÄŸru sÄ±ralamayÄ± dÃ¼zeltiyoruz (Data Consistency)
        const dataToSave = [...currentData].reverse();

        const token = localStorage.getItem('gh_token');
        const bodyData = {
            message: "Admin Panel Update ðŸš€",
            content: window.btoa(unescape(encodeURIComponent(JSON.stringify(dataToSave, null, 2)))),
            sha: fileSha
        };

        try {
            const res = await fetch(`https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/contents/${FILE_PATH}`, {
                method: 'PUT',
                headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify(bodyData)
            });
            if (!res.ok) throw new Error("Hata oluÅŸtu");
            const data = await res.json();
            fileSha = data.content.sha;
            document.querySelectorAll('.changed-row').forEach(row => row.classList.remove('changed-row'));
            alert("âœ… Kaydedildi!");
        } catch (e) { alert(e.message); }
    }
</script>
</body>
</html>
