<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Game Hub - Admin Paneli</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f6f9; }
        .container { max-width: 1200px; margin-top: 30px; }
        .status-badge { font-size: 0.8em; }
        .loading { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 9999; text-align: center; padding-top: 20%; }
        .changed-row { background-color: #fff3cd !important; } /* DeÄŸiÅŸiklik yapÄ±lan satÄ±r sarÄ± olur */
    </style>
</head>
<body>

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>ğŸ› ï¸ Oyun YÃ¶netim Paneli</h2>
        <button class="btn btn-primary" onclick="loadData()">ğŸ”„ Yenile</button>
    </div>

    <div id="loginSection" class="card p-4 mb-4">
        <h4>GiriÅŸ Yap</h4>
        <p class="text-muted">GitHub'dan aldÄ±ÄŸÄ±nÄ±z Token'Ä± giriniz.</p>
        <div class="input-group mb-3">
            <input type="password" id="githubToken" class="form-control" placeholder="ghp_..." value="">
            <button class="btn btn-success" onclick="verifyAndLoad()">GiriÅŸ Yap & Verileri Ã‡ek</button>
        </div>
        <small class="text-secondary">Token tarayÄ±cÄ±nÄ±zda geÃ§ici olarak saklanÄ±r.</small>
    </div>

    <div id="tableSection" style="display:none;">
        <div class="alert alert-info">
            DeÄŸiÅŸiklikleri yaptÄ±ktan sonra en alttaki veya saÄŸ Ã¼stteki <b>"Kaydet"</b> butonuna basmayÄ± unutmayÄ±n.
        </div>
        
        <div class="table-responsive bg-white rounded shadow-sm p-3">
            <table class="table table-hover align-middle">
                <thead class="table-dark">
                    <tr>
                        <th width="5%">Aktif</th>
                        <th width="10%">SÄ±nÄ±f</th>
                        <th width="10%">TÃ¼r</th>
                        <th width="25%">GÃ¶rÃ¼nen BaÅŸlÄ±k (DÃ¼zenlenebilir)</th>
                        <th width="30%">AÃ§Ä±klama (DÃ¼zenlenebilir)</th>
                        <th width="20%">Orijinal Dosya/KlasÃ¶r</th>
                    </tr>
                </thead>
                <tbody id="gameTableBody">
                    </tbody>
            </table>
        </div>

        <div class="d-grid gap-2 col-6 mx-auto mt-4 mb-5">
            <button class="btn btn-success btn-lg" onclick="saveChanges()">ğŸ’¾ DeÄŸiÅŸiklikleri GitHub'a Kaydet</button>
        </div>
    </div>
</div>

<div id="loader" class="loading">
    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
    <h3>Ä°ÅŸlem YapÄ±lÄ±yor...</h3>
</div>

<script>
    // --- AYARLAR ---
    // BURALARI KENDÄ° BÄ°LGÄ°LERÄ°NÄ°ZLE KONTROL EDÄ°N!
    const GITHUB_USERNAME = "hunter5234";  // GitHub kullanÄ±cÄ± adÄ±nÄ±z
    const REPO_NAME = "english-game-hub";      // Proje (Repo) adÄ±nÄ±z
    const FILE_PATH = "games_data.json";   // Veri dosyasÄ±
    
    // --- DEÄÄ°ÅKENLER ---
    let currentData = [];
    let fileSha = ""; // GitHub'a kaydederken dosya versiyonu iÃ§in gerekli

    // Token'Ä± localStorage'dan al (Varsa)
    document.getElementById('githubToken').value = localStorage.getItem('gh_token') || "";

    function showLoader(show) {
        document.getElementById('loader').style.display = show ? 'block' : 'none';
    }

    function verifyAndLoad() {
        const token = document.getElementById('githubToken').value;
        if (!token) { alert("LÃ¼tfen Token giriniz!"); return; }
        
        // Token'Ä± kaydet
        localStorage.setItem('gh_token', token);
        loadData();
    }

    // 1. VERÄ°LERÄ° Ã‡EKME (GET)
    async function loadData() {
        showLoader(true);
        const token = localStorage.getItem('gh_token');
        const url = `https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/contents/${FILE_PATH}`;

        try {
            const response = await fetch(url, {
                headers: { 
                    'Authorization': `token ${token}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });

            if (!response.ok) throw new Error("Veri Ã§ekilemedi! Token veya Repo bilgileri yanlÄ±ÅŸ olabilir.");

            const data = await response.json();
            fileSha = data.sha; // DosyanÄ±n parmak izini al (Kaydederken lazÄ±m)
            
            // GitHub iÃ§eriÄŸi Base64 kodludur, onu Ã§Ã¶zÃ¼yoruz:
            // TÃ¼rkÃ§e karakter sorunu olmamasÄ± iÃ§in decodeURIComponent escape trick kullanÄ±yoruz
            const decodedContent = decodeURIComponent(escape(window.atob(data.content)));
            currentData = JSON.parse(decodedContent);

            renderTable();
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('tableSection').style.display = 'block';

        } catch (error) {
            alert("Hata: " + error.message);
            console.error(error);
        } finally {
            showLoader(false);
        }
    }

    // 2. TABLOYU OLUÅTURMA
    function renderTable() {
        const tbody = document.getElementById('gameTableBody');
        tbody.innerHTML = "";

        // Ã–nce SÄ±nÄ±fa gÃ¶re sÄ±ralayalÄ±m
        currentData.sort((a, b) => a.grade.localeCompare(b.grade));

        currentData.forEach((item, index) => {
            const tr = document.createElement('tr');
            
            // GÃ¶rÃ¼nÃ¼rlÃ¼k (Checkbox)
            const isChecked = item.isVisible !== false ? "checked" : "";
            
            tr.innerHTML = `
                <td class="text-center">
                    <input type="checkbox" class="form-check-input" onchange="updateRow(${index}, 'isVisible', this.checked)" ${isChecked} style="transform: scale(1.3);">
                </td>
                <td><span class="badge bg-secondary">${item.grade}</span></td>
                <td><span class="badge ${item.source === 'Games' ? 'bg-primary' : 'bg-info'}">${item.source === 'Games' ? 'Oyun' : 'Aktivite'}</span></td>
                <td>
                    <input type="text" class="form-control" value="${item.title || ''}" onchange="updateRow(${index}, 'title', this.value)">
                </td>
                <td>
                    <input type="text" class="form-control form-control-sm" value="${item.description || ''}" placeholder="AÃ§Ä±klama ekle..." onchange="updateRow(${index}, 'description', this.value)">
                </td>
                <td class="text-muted small">
                    ${item.path}<br>
                    <i>(${item.name})</i>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    // 3. VERÄ°YÄ° GÃœNCELLEME (RAM Ã¼zerinde)
    window.updateRow = function(index, key, value) {
        currentData[index][key] = value;
        // GÃ¶rsel geri bildirim (SatÄ±r rengini deÄŸiÅŸtir)
        document.getElementById('gameTableBody').children[index].classList.add('changed-row');
    }

    // 4. DEÄÄ°ÅÄ°KLÄ°KLERÄ° GITHUB'A GÃ–NDERME (PUT)
    async function saveChanges() {
        if (!confirm("TÃ¼m deÄŸiÅŸiklikler siteye yansÄ±tÄ±lacak. Emin misiniz?")) return;

        showLoader(true);
        const token = localStorage.getItem('gh_token');
        const url = `https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/contents/${FILE_PATH}`;

        // JSON'u metne Ã§evirip TÃ¼rkÃ§e karakterleri bozmadan Base64'e kodla
        const jsonString = JSON.stringify(currentData, null, 2);
        const encodedContent = window.btoa(unescape(encodeURIComponent(jsonString)));

        const bodyData = {
            message: "Admin Panel Update ğŸ› ï¸",
            content: encodedContent,
            sha: fileSha // Hangi versiyonun Ã¼zerine yazdÄ±ÄŸÄ±mÄ±zÄ± belirtiyoruz
        };

        try {
            const response = await fetch(url, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(bodyData)
            });

            if (!response.ok) throw new Error("Kaydetme baÅŸarÄ±sÄ±z oldu!");

            const result = await response.json();
            fileSha = result.content.sha; // Yeni SHA'yÄ± gÃ¼ncelle
            alert("âœ… BaÅŸarÄ±yla Kaydedildi! Siteniz birkaÃ§ dakika iÃ§inde gÃ¼ncellenecektir.");
            
            // SatÄ±r renklerini temizle
            document.querySelectorAll('.changed-row').forEach(row => row.classList.remove('changed-row'));

        } catch (error) {
            alert("Hata oluÅŸtu: " + error.message);
        } finally {
            showLoader(false);
        }
    }
</script>

</body>
</html>
