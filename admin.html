<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>SÃ¼per Admin Paneli</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .container-fluid { max-width: 1400px; margin-top: 20px; }
        .changed-row { background-color: #fff8c4 !important; transition: 0.5s; }
        .table input, .table select { border: 1px solid #dee2e6; font-size: 0.9rem; }
        .table input:focus, .table select:focus { background-color: #fff; border-color: #86b7fe; box-shadow: 0 0 0 0.25rem rgba(13,110,253,.25); }
        .star-check { display: none; }
        .star-label { color: #ccc; cursor: pointer; font-size: 1.2rem; transition: 0.3s; }
        .star-check:checked + .star-label { color: #ffc107; transform: scale(1.2); }
        
        /* Renk SeÃ§ici */
        .color-dot { width: 20px; height: 20px; border-radius: 50%; display: inline-block; cursor: pointer; border: 2px solid transparent; }
        .color-dot.active { border-color: #333; transform: scale(1.2); }
    </style>
</head>
<body>

<div class="container-fluid mb-5">
    <div class="d-flex justify-content-between align-items-center bg-white p-3 rounded shadow-sm mb-4">
        <h3 class="m-0 text-primary"><i class="fa-solid fa-gamepad"></i> Game Hub YÃ¶netim</h3>
        <div>
            <span id="statusMsg" class="text-muted me-3"></span>
            <button class="btn btn-outline-primary me-2" onclick="loadData()"><i class="fa-solid fa-rotate"></i> Yenile</button>
            <button class="btn btn-success" onclick="saveChanges()"><i class="fa-solid fa-floppy-disk"></i> DeÄŸiÅŸiklikleri Kaydet</button>
        </div>
    </div>

    <div id="loginSection" class="row justify-content-center mt-5">
        <div class="col-md-4">
            <div class="card shadow">
                <div class="card-body p-4 text-center">
                    <i class="fa-solid fa-lock fa-3x text-secondary mb-3"></i>
                    <h5>GÃ¼venlik GiriÅŸi</h5>
                    <input type="password" id="githubToken" class="form-control mb-3" placeholder="GitHub Token YapÄ±ÅŸtÄ±r...">
                    <button class="btn btn-primary w-100" onclick="verifyAndLoad()">GiriÅŸ Yap</button>
                </div>
            </div>
        </div>
    </div>

    <div id="tableSection" style="display:none;" class="card shadow-sm">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th class="text-center" width="3%"><i class="fa-solid fa-eye"></i></th>
                            <th class="text-center" width="3%"><i class="fa-solid fa-star"></i></th>
                            <th width="10%">SÄ±nÄ±f</th>
                            <th width="12%">Ãœnite (Yeni)</th>
                            <th width="20%">Oyun BaÅŸlÄ±ÄŸÄ±</th>
                            <th width="10%">TÃ¼r</th>
                            <th width="10%">Renk</th>
                            <th width="20%">AÃ§Ä±klama</th>
                        </tr>
                    </thead>
                    <tbody id="gameTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div id="loader" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index:9999; text-align:center; padding-top:20%;">
    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
    <h4 class="mt-3">Ä°ÅŸleniyor...</h4>
</div>

<script>
    const GITHUB_USERNAME = "hunter5234";
    const REPO_NAME = "english-game-hub";
    const FILE_PATH = "games_data.json";

    let currentData = [];
    let fileSha = "";

    // SÄ±nÄ±f Listesi
    const gradeOptions = ["9TH_GRADE", "10TH_GRADE", "11TH_GRADE", "12TH_GRADE"];
    
    // Renk Listesi (Bootstrap sÄ±nÄ±flarÄ±)
    const colorOptions = [
        { name: "Mavi", val: "bg-primary", hex: "#0d6efd" },
        { name: "YeÅŸil", val: "bg-success", hex: "#198754" },
        { name: "KÄ±rmÄ±zÄ±", val: "bg-danger", hex: "#dc3545" },
        { name: "SarÄ±", val: "bg-warning", hex: "#ffc107" },
        { name: "Turkuaz", val: "bg-info", hex: "#0dcaf0" },
        { name: "Koyu", val: "bg-dark", hex: "#212529" }
    ];

    document.getElementById('githubToken').value = localStorage.getItem('gh_token') || "";

    function showLoader(show) { document.getElementById('loader').style.display = show ? 'block' : 'none'; }

    function verifyAndLoad() {
        const token = document.getElementById('githubToken').value;
        if(!token) return alert("Token giriniz");
        localStorage.setItem('gh_token', token);
        loadData();
    }

    async function loadData() {
        showLoader(true);
        const token = localStorage.getItem('gh_token');
        try {
            const res = await fetch(`https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/contents/${FILE_PATH}`, {
                headers: { 'Authorization': `token ${token}` }
            });
            if (!res.ok) throw new Error("Veri Ã§ekilemedi");
            
            const data = await res.json();
            fileSha = data.sha;
            currentData = JSON.parse(decodeURIComponent(escape(window.atob(data.content))));
            
            renderTable();
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('tableSection').style.display = 'block';
        } catch (e) { alert(e.message); } 
        finally { showLoader(false); }
    }

    function renderTable() {
        const tbody = document.getElementById('gameTableBody');
        tbody.innerHTML = "";
        
        // Ã–nce SÄ±nÄ±fa gÃ¶re sÄ±rala
        currentData.sort((a, b) => a.grade.localeCompare(b.grade));

        currentData.forEach((item, index) => {
            const tr = document.createElement('tr');
            
            // SINIF SEÃ‡Ä°MÄ° HTML
            let gradeSelect = `<select class="form-select form-select-sm" onchange="updateRow(${index}, 'grade', this.value)">`;
            gradeOptions.forEach(g => {
                gradeSelect += `<option value="${g}" ${item.grade === g ? 'selected' : ''}>${g}</option>`;
            });
            gradeSelect += `</select>`;

            // TÃœR SEÃ‡Ä°MÄ° HTML
            let typeSelect = `<select class="form-select form-select-sm" onchange="updateRow(${index}, 'source', this.value)">
                <option value="Games" ${item.source === 'Games' ? 'selected' : ''}>Oyun</option>
                <option value="Interactive_Activities" ${item.source === 'Interactive_Activities' ? 'selected' : ''}>Aktivite</option>
            </select>`;

            // RENK SEÃ‡Ä°MÄ° HTML
            let colorPicker = `<div class="d-flex gap-1">`;
            colorOptions.forEach(c => {
                const isActive = item.badgeColor === c.val ? 'active' : '';
                colorPicker += `<div class="color-dot ${isActive}" style="background-color:${c.hex}" title="${c.name}" onclick="updateColor(${index}, '${c.val}')"></div>`;
            });
            colorPicker += `</div>`;

            tr.innerHTML = `
                <td class="text-center">
                    <div class="form-check form-switch d-flex justify-content-center">
                        <input class="form-check-input" type="checkbox" onchange="updateRow(${index}, 'isVisible', this.checked)" ${item.isVisible !== false ? 'checked' : ''}>
                    </div>
                </td>
                <td class="text-center">
                    <input type="checkbox" id="star-${index}" class="star-check" onchange="updateRow(${index}, 'isFeatured', this.checked)" ${item.isFeatured ? 'checked' : ''}>
                    <label for="star-${index}" class="star-label"><i class="fa-solid fa-star"></i></label>
                </td>
                <td>${gradeSelect}</td>
                <td>
                    <input type="text" class="form-control form-control-sm" value="${item.unit || ''}" placeholder="Ã–rn: Unit 1" onchange="updateRow(${index}, 'unit', this.value)">
                </td>
                <td>
                    <input type="text" class="form-control fw-bold" value="${item.title || ''}" onchange="updateRow(${index}, 'title', this.value)">
                    <small class="text-muted" style="font-size:0.7em">${item.name}</small>
                </td>
                <td>${typeSelect}</td>
                <td>${colorPicker}</td>
                <td>
                    <input type="text" class="form-control form-control-sm" value="${item.description || ''}" onchange="updateRow(${index}, 'description', this.value)">
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    window.updateRow = function(index, key, value) {
        currentData[index][key] = value;
        document.getElementById('gameTableBody').children[index].classList.add('changed-row');
    }

    window.updateColor = function(index, colorVal) {
        currentData[index]['badgeColor'] = colorVal;
        document.getElementById('gameTableBody').children[index].classList.add('changed-row');
        renderTable(); // Renk deÄŸiÅŸikliÄŸini gÃ¶stermek iÃ§in tabloyu yenile (biraz kaba ama Ã§alÄ±ÅŸÄ±r)
    }

    async function saveChanges() {
        if (!confirm("Kaydetmek istediÄŸine emin misin?")) return;
        showLoader(true);
        const token = localStorage.getItem('gh_token');
        
        try {
            const bodyData = {
                message: "CMS Update ðŸš€",
                content: window.btoa(unescape(encodeURIComponent(JSON.stringify(currentData, null, 2)))),
                sha: fileSha
            };

            const res = await fetch(`https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/contents/${FILE_PATH}`, {
                method: 'PUT',
                headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify(bodyData)
            });

            if (!res.ok) throw new Error("Kaydetme hatasÄ±");
            const data = await res.json();
            fileSha = data.content.sha;
            
            document.querySelectorAll('.changed-row').forEach(row => row.classList.remove('changed-row'));
            alert("âœ… BaÅŸarÄ±yla kaydedildi!");
        } catch (e) { alert(e.message); }
        finally { showLoader(false); }
    }
</script>

</body>
</html>
