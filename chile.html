<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chile - Interactive Reading & Questions</title>
    <style>
        /* CSS Variables for Theming */
        :root {
            --bg-color: #1a1a2e;
            --primary-color: #16213e;
            --secondary-color: #0f3460;
            --accent-color: #e94560;
            --accent-hover-color: #533483;
            --text-color: #f5f5f5;
            --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* Global Styles */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: background-color 0.3s, color 0.3s;
        }

        /* Header Styles */
        header {
            background-color: var(--primary-color);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            z-index: 100;
            min-height: 70px;
        }
        .title { font-size: 24px; font-weight: bold; }
        .controls { display: flex; gap: 10px; align-items: center; }
        #themeSelector {
            padding: 8px 12px;
            border-radius: 5px;
            border: 1px solid var(--accent-color);
            background-color: var(--secondary-color);
            color: var(--text-color);
            font-size: 14px;
            cursor: pointer;
        }
        .score-display { font-size: 18px; font-weight: bold; color: #f39c12; margin-right: 15px; }
        button {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
            font-weight: 500;
        }
        button:hover { background-color: var(--accent-hover-color); }

        /* Main Content */
        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            padding: 20px;
            min-height: 0;
        }
        .content-wrapper {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 0;
            gap: 20px;
        }
        .reading {
            background-color: var(--secondary-color);
            padding: 25px;
            border-radius: 10px;
            overflow-y: auto;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            flex: 1;
            min-height: 0;
            display: flex;
            flex-direction: column;
        }
        .reading-content { flex: 1; }
        .reading p { margin-bottom: 20px; font-size: 20px; text-align: justify; }

        .highlight {
            background-color: var(--accent-color);
            padding: 3px 6px;
            border-radius: 4px;
            font-weight: bold;
            animation: pulse 1s infinite;
        }
        @keyframes pulse { 0%{transform:scale(1)} 50%{transform:scale(1.05)} 100%{transform:scale(1)} }

        /* Question Box */
        .qbox {
            background-color: var(--primary-color);
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            min-height: 200px;
        }
        .question { font-size: 22px; margin-bottom: 20px; font-weight: 500; }
        .options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        .option {
            background-color: var(--secondary-color);
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 18px;
            border: 2px solid transparent;
        }
        .option:hover { background-color: var(--accent-hover-color); transform: translateY(-2px); }
        .option.selected { background-color: var(--accent-hover-color); border-color: var(--accent-color); }

        .answer {
            display: none;
            background-color: var(--accent-color);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 18px;
            font-weight: 500;
        }
        .hint {
            display: none;
            background-color: var(--accent-hover-color);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 18px;
            font-weight: 500;
            border-left: 4px solid var(--accent-color);
        }
        .button-group { display: flex; gap: 10px; margin-top: 15px; }

        input[type="text"], textarea {
            width: 100%;
            padding: 15px;
            background-color: var(--secondary-color);
            color: var(--text-color);
            border: 2px solid var(--accent-hover-color);
            border-radius: 8px;
            font-size: 18px;
            margin-bottom: 15px;
            transition: border-color 0.3s;
        }
        input[type="text"]:focus, textarea:focus { outline: none; border-color: var(--accent-color); }

        /* Vocabulary Grid */
        .vocab-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 20px;
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }
        .vocab-card {
            background-color: var(--secondary-color);
            padding: 20px;
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 500;
            border: 2px solid transparent;
        }
        .vocab-card:hover { transform: translateY(-5px); background-color: var(--accent-hover-color); border-color: var(--accent-color); }
        .vocab-card.flipped { background-color: var(--accent-color); border-color: var(--text-color); }

        /* Vocabulary Game */
        .vocab-game-container {
            display: flex;
            flex: 1;
            gap: 30px;
            padding: 20px;
            justify-content: center;
            align-items: flex-start;
        }
        .vocab-game-column { display: flex; flex-direction: column; gap: 12px; width: 45%; }
        .vocab-game-card {
            background-color: var(--secondary-color);
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            font-size: 18px;
            font-weight: 500;
            border: 3px solid transparent;
            user-select: none;
        }
        .vocab-game-card:hover { transform: translateY(-3px); background-color: var(--accent-hover-color); }
        .vocab-game-card.selected { border-color: #f39c12; background-color: var(--accent-hover-color); transform: scale(1.05); }
        .vocab-game-card.matched { background-color: #27ae60; border-color: #2ecc71; cursor: default; transform: scale(1); animation: match-bounce 0.5s ease-out; }
        @keyframes match-bounce { 0%{transform:scale(1)} 50%{transform:scale(1.2)} 100%{transform:scale(1)} }
        .vocab-game-card.incorrect { animation: shake 0.5s; background-color: #c0392b; border-color: #e74c3c; }
        @keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-10px)} 75%{transform:translateX(10px)} }
        .game-message { text-align: center; font-size: 24px; font-weight: bold; color: #2ecc71; margin-top: 20px; }
        .game-controls { display: flex; justify-content: center; margin-top: 20px; }

        /* Navigation */
        nav {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 15px 20px;
            background-color: var(--primary-color);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
            min-height: 80px;
        }
        .progress-container {
            width: 100%;
            height: 10px;
            background-color: var(--secondary-color);
            border-radius: 5px;
            margin-bottom: 10px;
            overflow: hidden;
        }
        .progress-bar { height: 100%; width: 0%; background-color: var(--accent-color); transition: width 0.3s ease-in-out; }
        .nav-buttons { display: flex; justify-content: space-between; width: 100%; }
        #pageIndicator { font-size: 18px; font-weight: 500; }

        /* Footer */
        footer { background-color: var(--secondary-color); padding: 12px; text-align: center; font-size: 16px; font-weight: 500; }

        /* Completion Screen */
        .completion {
            display: none; flex-direction: column; align-items: center; justify-content: center;
            height: 100%; text-align: center; padding: 40px;
        }
        .completion h1 { font-size: 56px; margin-bottom: 30px; color: var(--accent-color); }
        .completion p { font-size: 28px; margin-bottom: 40px; }
        .final-score { font-size: 36px; color: #f39c12; margin-bottom: 20px; }

        /* Fullscreen Styles */
        body.fullscreen-mode .reading p { font-size: 25px; }
        body.fullscreen-mode .question { font-size: 30px; }
        body.fullscreen-mode .option { font-size: 20px; padding: 15px; }
        body.fullscreen-mode input[type="text"], body.fullscreen-mode textarea { font-size: 30px; padding: 20px; }
        body.fullscreen-mode .answer, body.fullscreen-mode .hint { font-size: 30px; padding: 20px; }
        body.fullscreen-mode .vocab-card { font-size: 18px; min-height: 150px; padding: 30px; }
        body.fullscreen-mode .vocab-game-card { font-size: 16px; padding: 18px; }
        body.fullscreen-mode .game-message { font-size: 36px; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: var(--primary-color); }
        ::-webkit-scrollbar-thumb { background: var(--accent-hover-color); border-radius: 5px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-color); }

        /* Theme Definitions */
        body.theme-light {
            --bg-color: #f5f5f5; --primary-color: #e0e0e0; --secondary-color: #ffffff;
            --accent-color: #3498db; --accent-hover-color: #2980b9; --text-color: #333333;
            --font-family: 'Arial', sans-serif;
        }
        body.theme-nature {
            --bg-color: #2c3e27; --primary-color: #3e4f37; --secondary-color: #4a6b49;
            --accent-color: #8bc34a; --accent-hover-color: #7cb342; --text-color: #e8f5e9;
            --font-family: 'Georgia', serif;
        }
        body.theme-tech {
            --bg-color: #263238; --primary-color: #37474f; --secondary-color: #455a64;
            --accent-color: #00bcd4; --accent-hover-color: #00acc1; --text-color: #eceff1;
            --font-family: 'Roboto Mono', monospace;
        }

        /* Confetti */
        .confetti {
            position: fixed; width: 10px; height: 10px; background-color: #f00;
            position: absolute; animation: confetti-fall 3s linear forwards;
        }
        @keyframes confetti-fall {
            to { transform: translateY(100vh) rotate(360deg); opacity: 0; }
        }
    </style>
</head>
<body>
<header>
    <div class="title">Chile - Interactive Reading & Questions (A2 Level)</div>
    <div class="controls">
        <div class="score-display">Score: <span id="score">0</span></div>
        <select id="themeSelector">
            <option value="dark-blue">Dark Blue</option>
            <option value="light">Light</option>
            <option value="nature">Nature</option>
            <option value="tech">Tech</option>
        </select>
        <button id="readBtn">üîä Read</button>
        <button id="pauseBtn" style="display:none;">‚è∏Ô∏è Pause</button>
        <button id="resumeBtn" style="display:none;">‚ñ∂Ô∏è Resume</button>
        <button id="stopBtn" style="display:none;">‚èπÔ∏è Stop</button>
        <button id="fullscreenBtn">‚õ∂ Fullscreen</button>
    </div>
</header>

<main>
    <div class="content-wrapper">
        <div class="reading" id="reading">
            <div class="reading-content" id="readingContent">
                <!-- Reading content will be inserted here -->
            </div>
        </div>

        <div class="qbox" id="qbox">
            <!-- Question content will be inserted here -->
        </div>

        <div class="vocab-grid" id="vocabGrid" style="display:none;">
            <!-- Vocabulary cards will be inserted here -->
        </div>

        <div class="vocab-game-container" id="vocabGameContainer" style="display:none;">
            <!-- Vocabulary Game will be inserted here -->
        </div>

        <div class="completion" id="completion">
            <h1>üéâ You've completed all questions!</h1>
            <div class="final-score">Your Final Score: <span id="finalScore">0</span></div>
            <p>Great job on learning about Chile!</p>
            <button id="restartBtn">üîÑ Restart</button>
        </div>
    </div>
</main>

<nav>
    <div class="progress-container">
        <div class="progress-bar" id="progressBar"></div>
    </div>
    <div class="nav-buttons">
        <button id="prevBtn">‚¨ÖÔ∏è Previous</button>
        <span id="pageIndicator">Page 1</span>
        <button id="nextBtn">Next ‚û°Ô∏è</button>
    </div>
</nav>

<footer>
    Bu √ßalƒ±≈üma ƒ∞ngilizce √ñƒüretmeni Abdullah AYDINHAN tarafƒ±ndan yapƒ±lmƒ±≈ütƒ±r.
</footer>

<script>
/* =========================
   Content Variables (CHILE)
   ========================= */
const TOPIC = "Chile";
const LEVEL = "A2";

const PASSAGE = `
<p><strong>A</strong> Located in western South America, the Republic of Chile is the <em>southernmost country</em> in the world. It is very close to Antarctica and extends across the <em>Andes Mountains</em> and the <em>Pacific Ocean</em> as a narrow strip of land. It is near Argentina, Peru, and Bolivia. If you go on a journey to Chile, you can go sightseeing in these countries as well.</p>

<p><strong>B</strong> Its <em>enormous geographical length</em>, mostly full of mountains, can cause a wide range of temperatures; that is why the country has the <em>driest desert in the world</em> and millennia-old glaciers. The ancient ruins, its climatic contrasts, diverse landscapes, natural beauty, and rich cultural heritage make the country <em>unique</em>.</p>

<p><strong>C</strong> In particular, you can experience the incredible natural beauty of <em>Torres del Paine National Park</em>; it consists of fascinating lakes, amazing glaciers, green forests, and rivers. You can go <em>hiking</em> and <em>trekking</em> in this magnificent scenery. On the other hand, the <em>Atacama Desert</em> and <em>Chilo√© Island</em> can also offer wonderful adventures for you.</p>

<p><strong>D</strong> The largest city and capital of the country is <em>Santiago</em>; it is in a valley and surrounded by snow-covered mountains. You can engage in plenty of sporting events in Santiago, including <em>snowboarding</em>, <em>climbing</em>, and <em>hiking</em>. On the same day, you can ski in the Andes Mountains, walk down the beach, and surf in the Pacific Ocean.</p>

<p><strong>E</strong> The official language in the country is <em>Spanish</em>, but the Chileans can also speak English. They are kind, friendly, and welcoming. The Chileans are an ethnic mix of Europeans and indigenous peoples, mostly <em>Mapuche</em>. Indigenous ancestors and European influences come together to create a <em>rich culture</em>. You can observe this culture in the country and feel it throughout its diverse populations.</p>
`;

const VOCAB_LIST = [
    ["southernmost", "en g√ºneydeki"],
    ["Antarctica", "Antarktika"],
    ["Andes Mountains", "And Daƒülarƒ±"],
    ["Pacific Ocean", "Pasifik Okyanusu"],
    ["narrow strip", "dar ≈üerit"],
    ["western South America", "G√ºney Amerika'nƒ±n batƒ±sƒ±"],
    ["geographical length", "coƒürafi uzunluk"],
    ["driest desert", "en kurak √ß√∂l"],
    ["glacier", "buzul"],
    ["ancient ruins", "antik kalƒ±ntƒ±lar"],
    ["climatic contrasts", "iklimsel kar≈üƒ±tlƒ±klar"],
    ["diverse landscapes", "√ße≈üitli manzaralar"],
    ["heritage", "miras"],
    ["unique", "benzersiz"],
    ["Torres del Paine", "Torres del Paine"],
    ["national park", "milli park"],
    ["fascinating", "b√ºy√ºleyici"],
    ["lake", "g√∂l"],
    ["forest", "orman"],
    ["river", "nehir"],
    ["hiking", "doƒüa y√ºr√ºy√º≈ü√º"],
    ["trekking", "trekking/daƒü y√ºr√ºy√º≈ü√º"],
    ["Atacama Desert", "Atacama √á√∂l√º"],
    ["Chilo√© Island", "Chilo√© Adasƒ±"],
    ["Santiago", "Santiago"],
    ["valley", "vadi"],
    ["snow-covered", "karla kaplƒ±"],
    ["snowboarding", "snowboard"],
    ["climbing", "tƒ±rmanƒ±≈ü"],
    ["surf", "s√∂rf yapmak"],
    ["official language", "resm√Æ dil"],
    ["indigenous", "yerli"],
    ["Mapuche", "Mapu√ße"],
    ["welcoming", "misafirperver"],
    ["heritage (cultural)", "k√ºlt√ºrel miras"],
    ["ancestors", "atalar"],
    ["influences", "etkiler"],
    ["neighbouring countries", "kom≈üu √ºlkeler"],
    ["sightseeing", "gezip g√∂rme"],
    ["magnificent scenery", "muhte≈üem manzara"]
];

const TF_QUESTIONS = [
    { prompt: "Chile is located in western South America and is very close to Antarctica.", answer: "True", highlights: ["Located in western South America", "very close to Antarctica"], hint: "Paragraph A mentions location and Antarctica." },
    { prompt: "Chile is described as a wide country from east to west.", answer: "False", highlights: ["extends across the Andes Mountains and the Pacific Ocean as a narrow strip of land"], hint: "Look for the phrase 'narrow strip of land' in paragraph A." },
    { prompt: "Chile includes the driest desert in the world and millennia-old glaciers.", answer: "True", highlights: ["driest desert in the world", "millennia-old glaciers"], hint: "Paragraph B lists climate extremes." },
    { prompt: "Torres del Paine National Park is famous for lakes, glaciers, forests, and rivers.", answer: "True", highlights: ["fascinating lakes, amazing glaciers, green forests, and rivers"], hint: "Paragraph C describes the park." },
    { prompt: "Santiago is a coastal city at sea level with no mountains nearby.", answer: "False", highlights: ["Santiago; it is in a valley and surrounded by snow-covered mountains"], hint: "Check the setting of Santiago in paragraph D." },
    { prompt: "You can ski in the Andes and surf in the Pacific Ocean on the same day.", answer: "True", highlights: ["on the same day, you can ski in the Andes Mountains ... and surf in the Pacific Ocean"], hint: "Paragraph D mentions this contrast." },
    { prompt: "Spanish is not an official language in Chile according to the passage.", answer: "False", highlights: ["The official language in the country is Spanish"], hint: "Paragraph E states the official language." },
    { prompt: "The Chilean people are described as kind, friendly, and welcoming.", answer: "True", highlights: ["They are kind, friendly, and welcoming"], hint: "See paragraph E." },
    { prompt: "Chile's culture only comes from European influences.", answer: "False", highlights: ["an ethnic mix of Europeans and indigenous peoples, mostly Mapuche", "Indigenous ancestors and European influences come together"], hint: "Culture is a mix per paragraph E." },
    { prompt: "Atacama Desert and Chilo√© Island are suggested as places for adventures.", answer: "True", highlights: ["the Atacama Desert and Chilo√© Island can also offer wonderful adventures"], hint: "Paragraph C mentions them." }
];

const MCQ_QUESTIONS = [
    {
        prompt: "Which oceans and mountains form Chile‚Äôs natural borders in the passage?",
        options: ["Atlantic Ocean and Alps", "Pacific Ocean and Andes Mountains", "Indian Ocean and Himalayas", "Arctic Ocean and Rockies"],
        answer: 1,
        highlights: ["Andes Mountains", "Pacific Ocean"],
        hint: "Paragraph A mentions both a mountain range and an ocean."
    },
    {
        prompt: "Which of the following is a reason Chile has varied temperatures?",
        options: ["It is an island", "Its enormous geographical length and mountains", "It is at the equator", "It has no mountains"],
        answer: 1,
        highlights: ["enormous geographical length, mostly full of mountains, can cause a wide range of temperatures"],
        hint: "See paragraph B."
    },
    {
        prompt: "Which national park is highlighted for its natural beauty?",
        options: ["Yellowstone", "Banff", "Torres del Paine National Park", "Kruger"],
        answer: 2,
        highlights: ["Torres del Paine National Park"],
        hint: "Paragraph C names a specific park."
    },
    {
        prompt: "Which activities are mentioned as possible in Santiago?",
        options: ["Only surfing", "Snowboarding, climbing, and hiking", "Only skiing", "Only sailing"],
        answer: 1,
        highlights: ["including snowboarding, climbing, and hiking"],
        hint: "Paragraph D lists activities."
    },
    {
        prompt: "Which of the following pairs are neighboring countries of Chile mentioned in the text?",
        options: ["Brazil and Uruguay", "Peru and Bolivia", "Colombia and Venezuela", "Ecuador and Paraguay"],
        answer: 1,
        highlights: ["near Argentina, Peru, and Bolivia"],
        hint: "See paragraph A."
    },
    {
        prompt: "Which two places offer adventures besides Torres del Paine?",
        options: ["Patagonia and Buenos Aires", "Atacama Desert and Chilo√© Island", "Machu Picchu and Iguaz√∫ Falls", "Salar de Uyuni and Gal√°pagos"],
        answer: 1,
        highlights: ["Atacama Desert and Chilo√© Island"],
        hint: "Paragraph C mentions two more places."
    },
    {
        prompt: "What is the capital and largest city of Chile?",
        options: ["Valpara√≠so", "Santiago", "Concepci√≥n", "La Serena"],
        answer: 1,
        highlights: ["The largest city and capital of the country is Santiago"],
        hint: "Paragraph D states the capital."
    },
    {
        prompt: "How is Chile‚Äôs culture described?",
        options: ["Only European", "Only indigenous", "A mix of European and indigenous influences", "Completely modern and new"],
        answer: 2,
        highlights: ["an ethnic mix of Europeans and indigenous peoples, mostly Mapuche", "come together to create a rich culture"],
        hint: "See paragraph E."
    },
    {
        prompt: "What shape best describes Chile‚Äôs territory in the passage?",
        options: ["Circular land", "Square plateau", "Narrow strip of land", "Archipelago only"],
        answer: 2,
        highlights: ["as a narrow strip of land"],
        hint: "Paragraph A uses this phrase."
    },
    {
        prompt: "Which extreme is specifically mentioned as being in Chile?",
        options: ["Coldest inhabited place on Earth", "The driest desert in the world", "Highest waterfall in the world", "Deepest lake in the world"],
        answer: 1,
        highlights: ["driest desert in the world"],
        hint: "Paragraph B mentions a superlative desert."
    }
];

const FILL_QUESTIONS = [
    { prompt: "Chile is located in ______ South America.", answer: "western", highlights: ["Located in western South America"], hint: "Opposite of eastern." },
    { prompt: "The country is very close to ______.", answer: "Antarctica", highlights: ["very close to Antarctica"], hint: "The southern polar region." },
    { prompt: "Chile extends across the Andes Mountains and the ______ Ocean.", answer: "Pacific", highlights: ["Andes Mountains and the Pacific Ocean"], hint: "The largest ocean on Earth." },
    { prompt: "Chile is described as a ______ strip of land.", answer: "narrow", highlights: ["narrow strip of land"], hint: "Not wide." },
    { prompt: "The country has the ______ desert in the world.", answer: "driest", highlights: ["driest desert in the world"], hint: "Superlative form of 'dry'." },
    { prompt: "You can go hiking and ______ in this magnificent scenery.", answer: "trekking", highlights: ["go hiking and trekking"], hint: "A longer kind of hike." },
    { prompt: "The largest city and capital is ______.", answer: "Santiago", highlights: ["largest city and capital of the country is Santiago"], hint: "Starts with S." },
    { prompt: "People can ______ in the Pacific Ocean on the same day.", answer: "surf", highlights: ["surf in the Pacific Ocean"], hint: "A sport with waves." },
    { prompt: "The official language in the country is ______.", answer: "Spanish", highlights: ["The official language in the country is Spanish"], hint: "Language spoken in Spain too." },
    { prompt: "The Chileans are mostly an ethnic mix of Europeans and ______ peoples.", answer: "indigenous", highlights: ["ethnic mix of Europeans and indigenous peoples"], hint: "Native peoples." }
];

const OPEN_QUESTIONS = [
    {
        prompt: "Where is Chile located and what are its neighboring countries according to the passage?",
        model: "Chile is in western South America, very close to Antarctica, and it is near Argentina, Peru, and Bolivia.",
        highlights: ["Located in western South America", "very close to Antarctica", "near Argentina, Peru, and Bolivia"],
        hint: "See paragraph A for location and neighbors."
    },
    {
        prompt: "Why does Chile have a wide range of temperatures?",
        model: "Because of its enormous geographical length and mountains.",
        highlights: ["enormous geographical length", "mostly full of mountains", "wide range of temperatures"],
        hint: "Paragraph B explains the reason."
    },
    {
        prompt: "What natural features can you find in Torres del Paine National Park?",
        model: "Fascinating lakes, amazing glaciers, green forests, and rivers.",
        highlights: ["fascinating lakes, amazing glaciers, green forests, and rivers"],
        hint: "See paragraph C."
    },
    {
        prompt: "What contrasting activities can you do in Chile on the same day?",
        model: "You can ski in the Andes Mountains and surf in the Pacific Ocean, and you can also walk down the beach.",
        highlights: ["ski in the Andes Mountains", "surf in the Pacific Ocean", "walk down the beach"],
        hint: "Paragraph D mentions same-day contrasts."
    },
    {
        prompt: "How is Santiago geographically described in the passage?",
        model: "It is in a valley and surrounded by snow-covered mountains.",
        highlights: ["in a valley", "surrounded by snow-covered mountains"],
        hint: "Paragraph D describes its setting."
    },
    {
        prompt: "How is Chile‚Äôs culture formed according to the text?",
        model: "It is formed by the mix of indigenous ancestors and European influences, creating a rich culture.",
        highlights: ["Indigenous ancestors and European influences come together", "rich culture"],
        hint: "See paragraph E."
    },
    {
        prompt: "Name two other places besides Torres del Paine that offer adventures.",
        model: "The Atacama Desert and Chilo√© Island.",
        highlights: ["Atacama Desert", "Chilo√© Island"],
        hint: "Paragraph C mentions two places."
    },
    {
        prompt: "What makes Chile unique according to the passage?",
        model: "Its ancient ruins, climatic contrasts, diverse landscapes, natural beauty, and rich cultural heritage.",
        highlights: ["ancient ruins", "climatic contrasts", "diverse landscapes", "natural beauty", "rich cultural heritage", "unique"],
        hint: "See paragraph B."
    },
    {
        prompt: "What languages are mentioned as spoken by Chileans?",
        model: "Spanish is the official language, and Chileans can also speak English.",
        highlights: ["official language ... Spanish", "can also speak English"],
        hint: "Paragraph E states languages."
    },
    {
        prompt: "What outdoor sports are mentioned in connection with Santiago?",
        model: "Snowboarding, climbing, and hiking.",
        highlights: ["snowboarding", "climbing", "hiking"],
        hint: "See paragraph D."
    }
];

/* =========================
   Application State
   ========================= */
let currentSlide = 0;
let totalSlides = 3 + TF_QUESTIONS.length + MCQ_QUESTIONS.length + FILL_QUESTIONS.length + OPEN_QUESTIONS.length + 1;
let speechSynthesisObj = window.speechSynthesis;
let speechUtterance = null;
let isReading = false;
let isPaused = false;
let currentQuestionText = "";
let score = 0;

/* Vocabulary Game State */
let selectedEnglishCard = null;
let matchedPairs = new Set();
let turkishCardsMap = new Map();
let usedVocabIndices = new Set();
let currentVocabGameWords = [];

/* DOM Elements */
const readingDiv = document.getElementById('reading');
const readingContentDiv = document.getElementById('readingContent');
const qboxDiv = document.getElementById('qbox');
const vocabGridDiv = document.getElementById('vocabGrid');
const vocabGameContainerDiv = document.getElementById('vocabGameContainer');
const completionDiv = document.getElementById('completion');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const pageIndicator = document.getElementById('pageIndicator');
const readBtn = document.getElementById('readBtn');
const pauseBtn = document.getElementById('pauseBtn');
const resumeBtn = document.getElementById('resumeBtn');
const stopBtn = document.getElementById('stopBtn');
const fullscreenBtn = document.getElementById('fullscreenBtn');
const restartBtn = document.getElementById('restartBtn');
const themeSelector = document.getElementById('themeSelector');
const scoreDisplay = document.getElementById('score');
const finalScoreDisplay = document.getElementById('finalScore');
const progressBar = document.getElementById('progressBar');

/* Sounds (placeholder beeps) */
const correctSound = "data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT";
const wrongSound =  "data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT";
const winSound =    "data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT";

function playSound(soundData) {
    const audio = new Audio(soundData);
    audio.volume = 0.3;
    audio.play().catch(e => console.error("Audio play failed.", e));
}

/* Theme Management */
const THEMES = { 'dark-blue': 'theme-dark-blue', 'light': 'theme-light', 'nature': 'theme-nature', 'tech': 'theme-tech' };
function applyTheme(themeName) { document.body.className = THEMES[themeName] || ''; localStorage.setItem('selectedTheme', themeName); }
function initTheme() {
    const saved = localStorage.getItem('selectedTheme');
    if (saved) { themeSelector.value = saved; applyTheme(saved); }
    themeSelector.addEventListener('change', e => applyTheme(e.target.value));
}

/* Progress Bar */
function updateProgressBar() {
    const progress = (currentSlide / (totalSlides - 1)) * 100;
    progressBar.style.width = `${progress}%`;
}

/* Init */
function init() {
    showSlide(currentSlide);
    setupEventListeners();
    initTheme();
    setupFullscreenListener();
    updateProgressBar();
}

/* Listeners */
function setupEventListeners() {
    prevBtn.addEventListener('click', () => { if (currentSlide > 0) { currentSlide--; showSlide(currentSlide); } });
    nextBtn.addEventListener('click', () => { if (currentSlide < totalSlides - 1) { currentSlide++; showSlide(currentSlide); } });
    readBtn.addEventListener('click', startReading);
    pauseBtn.addEventListener('click', pauseReading);
    resumeBtn.addEventListener('click', resumeReading);
    stopBtn.addEventListener('click', stopReading);
    fullscreenBtn.addEventListener('click', toggleFullscreen);
    restartBtn.addEventListener('click', () => { score = 0; scoreDisplay.textContent = score; currentSlide = 0; showSlide(currentSlide); });

    document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowLeft' && currentSlide > 0) { currentSlide--; showSlide(currentSlide); }
        else if (e.key === 'ArrowRight' && currentSlide < totalSlides - 1) { currentSlide++; showSlide(currentSlide); }
        else if (e.key.toLowerCase() === 'f') { toggleFullscreen(); }
    });
}

/* Fullscreen */
function setupFullscreenListener() {
    document.addEventListener('fullscreenchange', handleFullscreenChange);
    document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
    document.addEventListener('mozfullscreenchange', handleFullscreenChange);
    document.addEventListener('MSFullscreenChange', handleFullscreenChange);
}
function handleFullscreenChange() {
    if (document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement) {
        document.body.classList.add('fullscreen-mode');
    } else {
        document.body.classList.remove('fullscreen-mode');
    }
}

/* Slides */
function showSlide(slideIndex) {
    readingDiv.style.display = 'none';
    qboxDiv.style.display = 'none';
    vocabGridDiv.style.display = 'none';
    vocabGameContainerDiv.style.display = 'none';
    completionDiv.style.display = 'none';

    stopReading();
    pageIndicator.textContent = `Page ${slideIndex + 1}`;
    updateProgressBar();

    if (slideIndex === 0) {
        vocabGridDiv.style.display = 'grid';
        showVocabulary();
    } else if (slideIndex === 1) {
        vocabGameContainerDiv.style.display = 'flex';
        showVocabGame();
    } else if (slideIndex === 2) {
        readingDiv.style.display = 'block';
        qboxDiv.style.display = 'none';
        readingContentDiv.innerHTML = PASSAGE;
    } else if (slideIndex === totalSlides - 1) {
        completionDiv.style.display = 'flex';
        finalScoreDisplay.textContent = score;
        launchConfetti();
        playSound(winSound);
    } else {
        readingDiv.style.display = 'block';
        qboxDiv.style.display = 'block';
        readingContentDiv.innerHTML = PASSAGE;

        const questionIndex = slideIndex - 3;

        if (questionIndex < TF_QUESTIONS.length) {
            showTFQuestion(TF_QUESTIONS[questionIndex]);
        } else if (questionIndex < TF_QUESTIONS.length + MCQ_QUESTIONS.length) {
            const mcqIndex = questionIndex - TF_QUESTIONS.length;
            showMCQQuestion(MCQ_QUESTIONS[mcqIndex]);
        } else if (questionIndex < TF_QUESTIONS.length + MCQ_QUESTIONS.length + FILL_QUESTIONS.length) {
            const fillIndex = questionIndex - TF_QUESTIONS.length - MCQ_QUESTIONS.length;
            showFillQuestion(FILL_QUESTIONS[fillIndex]);
        } else {
            const openIndex = questionIndex - TF_QUESTIONS.length - MCQ_QUESTIONS.length - FILL_QUESTIONS.length;
            showOpenQuestion(OPEN_QUESTIONS[openIndex]);
        }
    }
}

/* Vocabulary Cards */
function showVocabulary() {
    vocabGridDiv.innerHTML = '';
    VOCAB_LIST.forEach(([en, tr]) => {
        const card = document.createElement('div');
        card.className = 'vocab-card';
        card.textContent = en;
        card.addEventListener('click', function() {
            if (!this.classList.contains('flipped')) { this.classList.add('flipped'); this.textContent = tr; }
            else { this.classList.remove('flipped'); this.textContent = en; }
        });
        vocabGridDiv.appendChild(card);
    });
}

/* Vocabulary Game */
function getRandomVocabWords(count) {
    const available = [];
    for (let i = 0; i < VOCAB_LIST.length; i++) {
        if (!usedVocabIndices.has(i)) available.push(i);
    }
    if (available.length === 0) {
        usedVocabIndices.clear();
        for (let i = 0; i < VOCAB_LIST.length; i++) available.push(i);
    }
    const actual = Math.min(count, available.length);
    const selected = [];
    for (let i = 0; i < actual; i++) {
        const idx = Math.floor(Math.random() * available.length);
        const pick = available[idx];
        selected.push(pick);
        usedVocabIndices.add(pick);
        available.splice(idx, 1);
    }
    return selected.map(i => VOCAB_LIST[i]);
}

function showVocabGame() {
    selectedEnglishCard = null;
    matchedPairs.clear();
    turkishCardsMap.clear();
    currentVocabGameWords = getRandomVocabWords(10);
    vocabGameContainerDiv.innerHTML = "";

    const englishColumn = document.createElement('div');
    englishColumn.className = 'vocab-game-column';
    const turkishColumn = document.createElement('div');
    turkishColumn.className = 'vocab-game-column';

    currentVocabGameWords.forEach((pair, index) => {
        const card = document.createElement('div');
        card.className = 'vocab-game-card';
        card.textContent = pair[0];
        card.dataset.index = index;
        card.dataset.type = 'english';
        card.addEventListener('click', handleCardClick);
        englishColumn.appendChild(card);
    });

    const shuffledTurkish = currentVocabGameWords.map((pair, idx) => ({ word: pair[1], originalIndex: idx }))
        .sort(() => Math.random() - 0.5);

    shuffledTurkish.forEach(item => {
        const card = document.createElement('div');
        card.className = 'vocab-game-card';
        card.textContent = item.word;
        card.dataset.index = item.originalIndex;
        card.dataset.type = 'turkish';
        card.addEventListener('click', handleCardClick);
        turkishCardsMap.set(card, item.originalIndex);
        turkishColumn.appendChild(card);
    });

    vocabGameContainerDiv.appendChild(englishColumn);
    vocabGameContainerDiv.appendChild(turkishColumn);
}

function handleCardClick(event) {
    const card = event.target;
    const type = card.dataset.type;
    const index = parseInt(card.dataset.index);
    if (matchedPairs.has(index)) return;

    if (type === 'english') {
        if (selectedEnglishCard) selectedEnglishCard.classList.remove('selected');
        card.classList.add('selected');
        selectedEnglishCard = card;
    } else if (type === 'turkish') {
        if (!selectedEnglishCard) return;
        const englishIndex = parseInt(selectedEnglishCard.dataset.index);
        if (englishIndex === index) {
            card.classList.add('matched');
            selectedEnglishCard.classList.add('matched');
            matchedPairs.add(index);
            score += 10; scoreDisplay.textContent = score; playSound(correctSound);
            selectedEnglishCard.classList.remove('selected');
            selectedEnglishCard = null;

            if (matchedPairs.size === currentVocabGameWords.length) {
                setTimeout(() => {
                    vocabGameContainerDiv.innerHTML = `
                        <div class="game-message">üéâ Congratulations! You've matched all the words!</div>
                        <div class="game-controls">
                            <button id="playAgainBtn">üîÑ Play Again</button>
                        </div>
                    `;
                    playSound(winSound);
                    document.getElementById('playAgainBtn').addEventListener('click', showVocabGame);
                }, 500);
            }
        } else {
            card.classList.add('incorrect');
            selectedEnglishCard.classList.add('incorrect');
            playSound(wrongSound);
            setTimeout(() => {
                card.classList.remove('incorrect');
                selectedEnglishCard.classList.remove('incorrect');
                selectedEnglishCard.classList.remove('selected');
                selectedEnglishCard = null;
            }, 800);
        }
    }
}

/* Questions */
function showTFQuestion(question) {
    currentQuestionText = question.prompt;
    qboxDiv.innerHTML = `
        <div class="question">${question.prompt}</div>
        <div class="options">
            <div class="option" data-value="True">True</div>
            <div class="option" data-value="False">False</div>
        </div>
        <div class="button-group">
            <button id="showAnswerBtn">üí° Show Answer</button>
            <button id="showHintBtn">üí¨ Hint</button>
        </div>
        <div class="answer" id="answerDiv"></div>
        <div class="hint" id="hintDiv"></div>
    `;
    const showAnswerBtn = document.getElementById('showAnswerBtn');
    const showHintBtn = document.getElementById('showHintBtn');
    const answerDiv = document.getElementById('answerDiv');
    const hintDiv = document.getElementById('hintDiv');
    const options = document.querySelectorAll('.option');

    options.forEach(opt => opt.addEventListener('click', function(){ options.forEach(o => o.classList.remove('selected')); this.classList.add('selected'); }));
    showAnswerBtn.addEventListener('click', () => { answerDiv.textContent = `Answer: ${question.answer}`; answerDiv.style.display = 'block'; highlightText(question.highlights); playSound(correctSound); });
    showHintBtn.addEventListener('click', () => { hintDiv.textContent = `üí° Hint: ${question.hint}`; hintDiv.style.display = 'block'; });
}

function showMCQQuestion(question) {
    currentQuestionText = question.prompt;
    let optionsHTML = '';
    question.options.forEach((opt, idx) => optionsHTML += `<div class="option" data-value="${idx}">${opt}</div>`);
    qboxDiv.innerHTML = `
        <div class="question">${question.prompt}</div>
        <div class="options">${optionsHTML}</div>
        <div class="button-group">
            <button id="showAnswerBtn">üí° Show Answer</button>
            <button id="showHintBtn">üí¨ Hint</button>
        </div>
        <div class="answer" id="answerDiv"></div>
        <div class="hint" id="hintDiv"></div>
    `;
    const showAnswerBtn = document.getElementById('showAnswerBtn');
    const showHintBtn = document.getElementById('showHintBtn');
    const answerDiv = document.getElementById('answerDiv');
    const hintDiv = document.getElementById('hintDiv');
    const options = document.querySelectorAll('.option');

    options.forEach(opt => opt.addEventListener('click', function(){ options.forEach(o => o.classList.remove('selected')); this.classList.add('selected'); }));
    showAnswerBtn.addEventListener('click', () => { answerDiv.textContent = `Answer: ${question.options[question.answer]}`; answerDiv.style.display = 'block'; highlightText(question.highlights); playSound(correctSound); });
    showHintBtn.addEventListener('click', () => { hintDiv.textContent = `üí° Hint: ${question.hint}`; hintDiv.style.display = 'block'; });
}

function showFillQuestion(question) {
    currentQuestionText = question.prompt;
    qboxDiv.innerHTML = `
        <div class="question">${question.prompt}</div>
        <input type="text" id="fillAnswer" placeholder="Type your answer here">
        <div class="button-group">
            <button id="showAnswerBtn">üí° Show Answer</button>
            <button id="showHintBtn">üí¨ Hint</button>
        </div>
        <div class="answer" id="answerDiv"></div>
        <div class="hint" id="hintDiv"></div>
    `;
    const showAnswerBtn = document.getElementById('showAnswerBtn');
    const showHintBtn = document.getElementById('showHintBtn');
    const answerDiv = document.getElementById('answerDiv');
    const hintDiv = document.getElementById('hintDiv');

    showAnswerBtn.addEventListener('click', () => { answerDiv.textContent = `Answer: ${question.answer}`; answerDiv.style.display = 'block'; highlightText(question.highlights); playSound(correctSound); });
    showHintBtn.addEventListener('click', () => { hintDiv.textContent = `üí° Hint: ${question.hint}`; hintDiv.style.display = 'block'; });
}

function showOpenQuestion(question) {
    currentQuestionText = question.prompt;
    qboxDiv.innerHTML = `
        <div class="question">${question.prompt}</div>
        <textarea id="openAnswer" placeholder="Type your answer here" rows="4"></textarea>
        <div class="button-group">
            <button id="showAnswerBtn">üí° Show Model Answer</button>
            <button id="showHintBtn">üí¨ Hint</button>
        </div>
        <div class="answer" id="answerDiv"></div>
        <div class="hint" id="hintDiv"></div>
    `;
    const showAnswerBtn = document.getElementById('showAnswerBtn');
    const showHintBtn = document.getElementById('showHintBtn');
    const answerDiv = document.getElementById('answerDiv');
    const hintDiv = document.getElementById('hintDiv');

    showAnswerBtn.addEventListener('click', () => { answerDiv.textContent = `Model Answer: ${question.model}`; answerDiv.style.display = 'block'; highlightText(question.highlights); playSound(correctSound); });
    showHintBtn.addEventListener('click', () => { hintDiv.textContent = `üí° Hint: ${question.hint}`; hintDiv.style.display = 'block'; });
}

/* Highlight */
function highlightText(highlights) {
    let highlightedText = PASSAGE;
    highlights.forEach(phrase => {
        const escaped = phrase.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const regex = new RegExp(`(${escaped})`, 'gi');
        highlightedText = highlightedText.replace(regex, '<span class="highlight">$1</span>');
    });
    readingContentDiv.innerHTML = highlightedText;
}

/* Text-to-speech */
function startReading() {
    if (isReading && !isPaused) return;
    if (isPaused) { resumeReading(); return; }

    let textToRead = "";
    if (currentSlide >= 3 && currentSlide < totalSlides - 1) textToRead = currentQuestionText;
    else textToRead = readingContentDiv.innerText;

    speechUtterance = new SpeechSynthesisUtterance(textToRead);
    speechUtterance.lang = 'en-US';
    speechUtterance.rate = 0.9;
    speechUtterance.onend = () => { stopReading(); };

    speechSynthesisObj.speak(speechUtterance);
    isReading = true; isPaused = false;
    readBtn.style.display = 'none';
    pauseBtn.style.display = 'inline-block';
    stopBtn.style.display = 'inline-block';
}
function pauseReading() { if (!isReading || isPaused) return; speechSynthesisObj.pause(); isPaused = true; pauseBtn.style.display = 'none'; resumeBtn.style.display = 'inline-block'; }
function resumeReading() { if (!isReading || !isPaused) return; speechSynthesisObj.resume(); isPaused = false; resumeBtn.style.display = 'none'; pauseBtn.style.display = 'inline-block'; }
function stopReading() {
    if (!isReading) return;
    speechSynthesisObj.cancel();
    isReading = false; isPaused = false;
    readBtn.style.display = 'inline-block';
    pauseBtn.style.display = 'none';
    resumeBtn.style.display = 'none';
    stopBtn.style.display = 'none';
}

/* Fullscreen */
function toggleFullscreen() {
    if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(err => console.error(err.message));
    else document.exitFullscreen();
}

/* Confetti */
function launchConfetti() {
    const colors = ['#e94560', '#f39c12', '#2ecc71', '#3498db', '#9b59b6'];
    const confettiCount = 100;
    for (let i = 0; i < confettiCount; i++) {
        setTimeout(() => {
            const confetti = document.createElement('div');
            confetti.className = 'confetti';
            confetti.style.left = Math.random() * 100 + '%';
            confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
            confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
            document.body.appendChild(confetti);
            setTimeout(() => { confetti.remove(); }, 4000);
        }, i * 30);
    }
}

/* Start */
document.addEventListener('DOMContentLoaded', () => {
    showSlide(currentSlide);
    init();
});
</script>
</body>
</html>
